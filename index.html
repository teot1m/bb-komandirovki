<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>–í—ñ–¥—Ä—è–¥–∂–µ–Ω–Ω—è</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

  <style>
    :root {
      --primary-color: #0d6efd;
      --bg-color: #f0f2f5;
    }

    body {
      padding: 15px 0px 15px 0px;
      background-color: var(--bg-color);
      font-family: -apple-system, system-ui, sans-serif;
      padding-bottom: 90px;
    }

    input,
    select,
    textarea {
      font-size: 16px !important;
    }

    .card {
      border-radius: 16px;
      border: none;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.04);
      margin-bottom: 12px;
      transition: opacity 0.3s;
    }

    .nav-pills {
      background: #fff;
      padding: 5px;
      border-radius: 14px;
      margin-bottom: 20px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }

    .nav-pills .nav-link {
      border-radius: 10px;
      color: #6c757d;
      font-weight: 600;
      font-size: 0.9rem;
      padding: 10px;
    }

    .nav-pills .nav-link.active {
      background-color: var(--primary-color);
      color: #fff;
    }

    .badge-status {
      font-weight: 600;
      padding: 6px 12px;
      border-radius: 8px;
      font-size: 0.75rem;
      text-transform: uppercase;
    }

    .st-new {
      background-color: #e3f2fd;
      color: #0d47a1;
    }

    .st-approved {
      background-color: #d1e7dd;
      color: #0f5132;
    }

    .st-rejected {
      background-color: #f8d7da;
      color: #842029;
    }

    .st-clarify {
      background-color: #fff3cd;
      color: #664d03;
    }

    .st-clarified {
      background-color: #cff4fc;
      color: #055160;
    }

    .marker-flash {
      border-left: 5px solid #ffc107;
    }

    .marker-blue {
      border-left: 5px solid #0d6efd;
    }

    .marker-profi {
      border-left: 5px solid #6610f2;
    }

    .marker-gray {
      border-left: 5px solid #6c757d;
    }

    .marker-clarify {
      border-left: 5px solid #fd7e14;
    }

    .total-box {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 15px;
      border: 1px dashed #adb5bd;
    }

    .toast-container {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1060;
      width: 97%;
      max-width: 400px;
    }

    .toast {
      background: #333;
      color: #fff;
      border-radius: 12px;
    }

    .expense-form {
      background: #fff;
      border-radius: 12px;
      border: 1px solid #e9ecef;
      padding: 12px;
    }
  </style>
</head>

<body>

  <div class="container" style="max-width: 600px;">

    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
      <div>
        <small class="text-muted text-uppercase fw-bold" style="font-size: 0.65rem;">–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á</small>
        <div class="fw-bold fs-5 text-dark" id="ui-userName">...</div>
      </div>
      <div>
        <span class="badge bg-light text-dark border"><i class="bi bi-shield-lock"></i> <span
            id="ui-userRole">...</span></span>
        <button class="btn btn-sm btn-white text-primary ms-1" onclick="forceReload()">
          <i class="bi bi-arrow-clockwise fs-5"></i>
        </button>
      </div>
    </div>

    <ul class="nav nav-pills nav-fill" id="pills-tab"></ul>

    <div id="appContent">
      <div class="text-center mt-5 pt-4">
        <div class="spinner-border text-primary"></div>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast-container">
    <div id="liveToast" class="toast align-items-center border-0 shadow" role="alert" aria-live="assertive"
      aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body d-flex align-items-center">
          <i class="bi bi-info-circle-fill me-2 fs-5"></i>
          <span id="toastMessage">...</span>
        </div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>
  </div>

  <!-- Clarification Modal -->
  <div class="modal fade" id="clarifyModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h6 class="modal-title">–ü–æ—Ç—Ä–µ–±—É—î —É—Ç–æ—á–Ω–µ–Ω–Ω—è</h6>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <textarea class="form-control" id="clarifyText" rows="4"
            placeholder="–û–ø–∏—à—ñ—Ç—å, —â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ —É—Ç–æ—á–Ω–∏—Ç–∏..."></textarea>
          <input type="hidden" id="clarifyReqId">
        </div>
        <div class="modal-footer">
          <button class="btn btn-light" data-bs-dismiss="modal">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
          <button class="btn btn-warning text-dark" onclick="submitClarifyRequest()">–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏</button>
        </div>
      </div>
    </div>
  </div>

    <!-- Edit + Approve Modal -->
    <div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h6 class="modal-title">–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ —Ç–∞ –ø–æ–≥–æ–¥–∏—Ç–∏</h6>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="editReqId">
          <div class="mb-2">
            <label class="small text-muted fw-bold">–ö–æ–º–ø–∞–Ω—ñ—è</label>
            <input type="text" class="form-control" id="editCompany">
          </div>
          <div class="mb-2">
            <label class="small text-muted fw-bold">–í—ñ–¥–¥—ñ–ª</label>
            <input type="text" class="form-control" id="editDept">
          </div>
          <div class="mb-2">
            <label class="small text-muted fw-bold">–ú–µ—Ç–∞</label>
            <input type="text" class="form-control" id="editPurpose">
          </div>
          <div class="row g-2 mb-2">
            <div class="col-6">
              <label class="small text-muted fw-bold">–î–∞—Ç–∞ –ø–æ—á–∞—Ç–∫—É</label>
              <input type="date" class="form-control" id="editStart">
            </div>
            <div class="col-6">
              <label class="small text-muted fw-bold">–î–∞—Ç–∞ –∫—ñ–Ω—Ü—è</label>
              <input type="date" class="form-control" id="editEnd">
            </div>
          </div>
          <div class="row g-2 mb-2">
            <div class="col-6">
              <label class="small text-muted fw-bold">–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç</label>
              <input type="text" class="form-control" id="editTransType">
            </div>
            <div class="col-6">
              <label class="small text-muted fw-bold">–í–∞—Ä—Ç—ñ—Å—Ç—å —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç—É</label>
              <input type="number" class="form-control" id="editTransCost">
            </div>
          </div>
          <div class="row g-2 mb-2">
            <div class="col-6">
              <label class="small text-muted fw-bold">–õ—é–¥–µ–π</label>
              <input type="number" class="form-control" id="editPeople">
            </div>
            <div class="col-6">
              <label class="small text-muted fw-bold">–û–ø–ª–∞—Ç–∞</label>
              <input type="text" class="form-control" id="editPayment">
            </div>
          </div>
          <div class="mb-2">
            <label class="small text-muted fw-bold">–ö–∞—Ä—Ç–∞ (–∑–∞ –ø–æ—Ç—Ä–µ–±–∏)</label>
            <input type="text" class="form-control" id="editCard" placeholder="–ù–æ–º–µ—Ä –∞–±–æ –Ω–∞–∑–≤–∞ –∫–∞—Ä—Ç–∏">
          </div>
          <div class="mb-2">
            <label class="small text-muted fw-bold">–ö–æ–º–µ–Ω—Ç–∞—Ä –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞ (–æ–±–æ–≤'—è–∑–∫–æ–≤–æ)</label>
            <textarea class="form-control" id="editAdminComment" rows="3" placeholder="–ü—Ä–∏—á–∏–Ω–∞ –∑–º—ñ–Ω / –∫–æ–º–µ–Ω—Ç–∞—Ä"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-light" data-bs-dismiss="modal">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
          <button class="btn btn-success" onclick="submitEditApprove()">–ü–æ–≥–æ–¥–∏—Ç–∏</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Details Modal -->
  <div class="modal fade" id="detailsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h6 class="modal-title">–î–µ—Ç–∞–ª—ñ –∑–∞—è–≤–∫–∏</h6>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="detailsBody">
          <div class="text-center text-muted">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbx0v1qTvhc7VIjnEBfSTTGUT2jW8ITEzF6rJ4_ENgKzGLbC2MGiUKFTgUuOnG9sWgr-/exec";

    const urlParams = new URLSearchParams(window.location.search);
    const USER_ID = urlParams.get('userid');

    let USER_NAME = "";
    let USER_ROLE = "";
    let MY_COMPANIES = [];
    let DEPARTMENTS = [];
    let USER_CARDS = [];
    let CURRENT_VIEW = '';
    let toastInstance;
    let REQUEST_CACHE = {};
    let EXPENSE_CACHE = {};
    let clarifyModalInstance;
    let editModalInstance;
    let detailsModalInstance;
    let DETAILS_EXPENSE_CACHE = {};

    window.onload = async function () {
      toastInstance = new bootstrap.Toast(document.getElementById('liveToast'), { delay: 3000 });
      clarifyModalInstance = new bootstrap.Modal(document.getElementById('clarifyModal'));
      editModalInstance = new bootstrap.Modal(document.getElementById('editModal'));
      detailsModalInstance = new bootstrap.Modal(document.getElementById('detailsModal'));

      if (!USER_ID) {
        document.getElementById('appContent').innerHTML = '<div class="alert alert-danger text-center">–ù–µ –≤–∫–∞–∑–∞–Ω–æ User ID</div>';
        return;
      }

      // --- –ö–õ–ò–ï–ù–¢–°–ö–û–ï –ö–≠–®–ò–†–û–í–ê–ù–ò–ï ---
      // 1. –ü—Ä–æ–±—É–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç—å—Å—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –∏–∑ –ø–∞–º—è—Ç–∏ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
      const cachedUser = localStorage.getItem('trip_user_' + USER_ID);
      const cachedDepts = localStorage.getItem('trip_depts');

      if (cachedUser && cachedDepts) {
        console.log("Loaded from local cache");
        applyUserData(JSON.parse(cachedUser));
        DEPARTMENTS = JSON.parse(cachedDepts);
        initApp();

        // –í —Ñ–æ–Ω–µ –æ–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ (—á—Ç–æ–±—ã –µ—Å–ª–∏ –ø—Ä–∞–≤–∞ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å, —é–∑–µ—Ä —É–∑–Ω–∞–ª –æ–± —ç—Ç–æ–º)
        fetchUserData(true);
      } else {
        // –ï—Å–ª–∏ –∫—ç—à–∞ –Ω–µ—Ç, –≥—Ä—É–∑–∏–º —Å —Å–µ—Ä–≤–µ—Ä–∞
        await fetchUserData(false);
      }
    };

    async function fetchUserData(inBackground) {
      try {
        const [resUser, resDep] = await Promise.all([
          fetch(`${API_URL}?action=getUserInfo&userId=${USER_ID}`),
          fetch(`${API_URL}?action=getDepartments`)
        ]);

        const userData = await resUser.json();
        const deptData = await resDep.json();

        if (userData.error) {
          if (!inBackground) document.getElementById('appContent').innerHTML = `<div class="alert alert-danger text-center">${userData.error}</div>`;
          return;
        }

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ø–∞–º—è—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω–∞
        localStorage.setItem('trip_user_' + USER_ID, JSON.stringify(userData));
        localStorage.setItem('trip_depts', JSON.stringify(deptData));

        // –ï—Å–ª–∏ —ç—Ç–æ –Ω–µ —Ñ–æ–Ω–æ–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ, –ø—Ä–∏–º–µ–Ω—è–µ–º –∏ —Ä–µ–Ω–¥–µ—Ä–∏–º
        if (!inBackground) {
          applyUserData(userData);
          DEPARTMENTS = deptData;
          initApp();
        } else {
          // –ï—Å–ª–∏ —Ñ–æ–Ω–æ–≤–æ–µ - –ø—Ä–æ—Å—Ç–æ –æ–±–Ω–æ–≤–ª—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
          applyUserData(userData);
          DEPARTMENTS = deptData;
        }
      } catch (e) {
        if (!inBackground) showToast("–ü–æ–º–∏–ª–∫–∞ –∑'—î–¥–Ω–∞–Ω–Ω—è: " + e);
      }
    }

    function applyUserData(data) {
      USER_NAME = data.name;
      USER_ROLE = data.role;
      const raw = data.company || "";
      MY_COMPANIES = raw.split(',').map(c => c.trim()).filter(c => c.length > 0);
      const cardsRaw = (data.cards || "").toString();
      USER_CARDS = cardsRaw.split(/\r?\n/).map(c => c.trim()).filter(c => c.length > 0);

      document.getElementById('ui-userName').innerText = USER_NAME;
      document.getElementById('ui-userRole').innerText = USER_ROLE;
    }

    function forceReload() {
      localStorage.removeItem('trip_user_' + USER_ID); // –ß–∏—Å—Ç–∏–º –∫—ç—à
      localStorage.removeItem('trip_depts');
      location.reload();
    }

    function initApp() {
      const nav = document.getElementById('pills-tab');
      // –ï—Å–ª–∏ –º–µ–Ω—é —É–∂–µ –µ—Å—Ç—å, –Ω–µ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –µ–≥–æ (—á—Ç–æ–±—ã –Ω–µ –º–æ—Ä–≥–∞–ª–æ –ø—Ä–∏ —Ñ–æ–Ω–æ–≤–æ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏)
      if (nav.innerHTML.trim() === "") {
        if (USER_ROLE === '–ê–¥–º—ñ–Ω') {
          nav.innerHTML = `
                <li class="nav-item"><a class="nav-link active" onclick="loadApproverPending()">‚ö° –ü–æ–≥–æ–¥–∏—Ç–∏</a></li>
                <li class="nav-item"><a class="nav-link" onclick="loadUserHistory()">üìÇ –ú–æ—ó</a></li>
                <li class="nav-item"><a class="nav-link" onclick="loadUserCreate()">‚ûï –°—Ç–≤–æ—Ä–∏—Ç–∏</a></li>
              `;
          loadApproverPending();
        } else {
          nav.innerHTML = `
                <li class="nav-item"><a class="nav-link active" onclick="loadUserCreate()">‚ûï –°—Ç–≤–æ—Ä–∏—Ç–∏</a></li>
                <li class="nav-item"><a class="nav-link" onclick="loadUserHistory()">üìã –Ü—Å—Ç–æ—Ä—ñ—è</a></li>
              `;
          loadUserCreate();
        }
      }
    }

    function refreshTab() {
      if (CURRENT_VIEW === 'create') loadUserCreate();
      else if (CURRENT_VIEW === 'history') loadUserHistory();
      else if (CURRENT_VIEW === 'pending') loadApproverPending();
    }

    function setActiveTab(idx) {
      document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
      const target = document.querySelectorAll('.nav-link')[idx];
      if (target) target.classList.add('active');
    }

    async function sendPost(action, data) {
      const response = await fetch(API_URL, {
        method: 'POST',
        body: JSON.stringify({ action: action, ...data })
      });
      return await response.json();
    }

    // === CREATE FORM ===
    function loadUserCreate() {
      CURRENT_VIEW = 'create';
      const tabIdx = USER_ROLE === '–ê–¥–º—ñ–Ω' ? 2 : 0;
      setActiveTab(tabIdx);

      const deptOpts = DEPARTMENTS.map(d => `<option value="${d}">${d}</option>`).join('');
      let companyOpts = MY_COMPANIES.length > 0
        ? MY_COMPANIES.map(c => `<option value="${c}">${c}</option>`).join('')
        : `<option disabled selected>–ù–µ–º–∞—î –¥–æ—Å—Ç—É–ø—É –¥–æ –∫–æ–º–ø–∞–Ω—ñ–π</option>`;

      const today = new Date().toISOString().split('T')[0];
      const cardOptions = USER_CARDS.length
        ? USER_CARDS.map(c => `<option value="${c}">${c}</option>`).join('')
        : `<option value="" disabled selected>–ù–µ–º–∞—î –∫–∞—Ä—Ç</option>`;

      document.getElementById('appContent').innerHTML = `
          <div class="card p-4 shadow-sm animate__animated animate__fadeIn">
            <form id="tripForm" onsubmit="submitRequest(event)">
              <div class="mb-3"><label class="small text-muted fw-bold">–ö–æ–º–ø–∞–Ω—ñ—è</label><select class="form-select fw-bold" name="company" required>${companyOpts}</select></div>
              <div class="mb-3"><label class="small text-muted fw-bold">–í—ñ–¥–¥—ñ–ª</label><select class="form-select" name="department" required><option value="" disabled selected>–û–±–µ—Ä—ñ—Ç—å –≤—ñ–¥–¥—ñ–ª...</option>${deptOpts}</select></div>
              <div class="mb-3"><label class="small text-muted fw-bold">–ú–µ—Ç–∞ –≤—ñ–¥—Ä—è–¥–∂–µ–Ω–Ω—è</label><input type="text" class="form-control" name="purpose" placeholder="–ù–∞–ø—Ä: –¢—Ä–µ–Ω—ñ–Ω–≥, –í–∏—Å—Ç–∞–≤–∫–∞..." required></div>
              <div class="mb-3"><label class="small text-muted fw-bold">–ö–æ–º–µ–Ω—Ç–∞—Ä</label><input type="text" class="form-control" name="comment" placeholder="–ö–æ–º–µ–Ω—Ç–∞—Ä –¥–æ –∑–∞—è–≤–∫–∏ (–Ω–µ–æ–±–æ–≤'—è–∑–∫–æ–≤–æ)"></div>
              <div class="row g-2 mb-3">
                <div class="col-6"><label class="small text-muted fw-bold">–î–∞—Ç–∞ –ø–æ—á–∞—Ç–∫—É</label><input type="date" class="form-control" name="dateStart" id="dStart" min="${today}" onchange="calcTotal()" required></div>
                <div class="col-6"><label class="small text-muted fw-bold">–î–∞—Ç–∞ –∫—ñ–Ω—Ü—è</label><input type="date" class="form-control" name="dateEnd" id="dEnd" min="${today}" onchange="calcTotal()" required></div>
              </div>
              <div class="mb-3">
                <label class="small text-muted fw-bold">–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç</label>
                <select class="form-select mb-2" name="transportType" required><option value="–ü–æ—ó–∑–¥">–ü–æ—ó–∑–¥</option><option value="–ê–≤—Ç–æ (–ë–µ–Ω–∑–∏–Ω)">–ê–≤—Ç–æ (–ë–µ–Ω–∑–∏–Ω)</option><option value="–ê–≤—Ç–æ–±—É—Å">–ê–≤—Ç–æ–±—É—Å</option><option value="–õ—ñ—Ç–∞–∫">–õ—ñ—Ç–∞–∫</option></select>
                <input type="number" class="form-control" name="transportCost" id="tCost" placeholder="–í–∞—Ä—Ç—ñ—Å—Ç—å –∫–≤–∏—Ç–∫—ñ–≤ (–≥—Ä–Ω)" oninput="calcTotal()" required>
              </div>
              <div class="row g-2 mb-3">
                 <div class="col-6"><label class="small text-muted fw-bold">–õ—é–¥–µ–π</label><input type="number" class="form-control" name="peopleCount" id="pCount" value="1" min="1" oninput="calcTotal()" required></div>
                 <div class="col-6"><label class="small text-muted fw-bold">–û–ø–ª–∞—Ç–∞</label><select class="form-select" name="paymentMethod" onchange="toggleCardSelect(this.value)"><option value="–ö–∞—Ä—Ç–∞">üí≥ –ù–∞ –∫–∞—Ä—Ç—É</option><option value="–ì–æ—Ç—ñ–≤–∫–∞">üíµ –ì–æ—Ç—ñ–≤–∫–∞</option></select></div>
              </div>
              <div class="mb-3" id="cardSelectBlock">
                <label class="small text-muted fw-bold">–ö–∞—Ä—Ç–∞ –¥–ª—è –∑–∞—Ä–∞—Ö—É–≤–∞–Ω–Ω—è</label>
                <select class="form-select" name="paymentCard" ${USER_CARDS.length ? '' : 'disabled'}>${cardOptions}</select>
              </div>
              <div class="total-box mb-3">
                <div class="d-flex justify-content-between mb-1"><small class="text-muted">–î–æ–±–æ–≤—ñ (700 ‚Ç¥):</small><small class="fw-bold" id="calcDaily">0 ‚Ç¥</small></div>
                <div class="d-flex justify-content-between align-items-center border-top pt-2 mt-2"><span class="fw-bold text-dark">–í–°–¨–û–ì–û:</span><span class="fs-5 fw-bold text-primary" id="calcTotal">0 ‚Ç¥</span></div>
              </div>
              <button type="submit" id="btnSubmit" class="btn btn-primary w-100 py-3 rounded-pill fw-bold shadow">–°—Ç–≤–æ—Ä–∏—Ç–∏ –∑–∞—è–≤–∫—É</button>
            </form>
          </div>`;
    }

    function calcTotal() {
      const dS = document.getElementById('dStart').value;
      const dE = document.getElementById('dEnd').value;
      const cost = parseFloat(document.getElementById('tCost').value) || 0;
      const people = parseInt(document.getElementById('pCount').value) || 1;

      if (dS && dE) {
        const start = new Date(dS);
        const end = new Date(dE);
        if (start > end) {
          document.getElementById('calcDaily').innerText = '-';
          document.getElementById('calcTotal').innerText = '-';
          return;
        }
        const diffDays = Math.ceil(Math.abs(end - start) / (86400000)) + 1;
        const dailySum = diffDays * 700 * people;
        document.getElementById('calcDaily').innerText = dailySum.toLocaleString() + ' ‚Ç¥';
        document.getElementById('calcTotal').innerText = (dailySum + cost).toLocaleString() + ' ‚Ç¥';
      }
    }

    function toggleCardSelect(method) {
      const block = document.getElementById('cardSelectBlock');
      if (!block) return;
      if (method === '–ö–∞—Ä—Ç–∞') {
        block.classList.remove('d-none');
      } else {
        const sel = block.querySelector('select');
        if (sel) sel.value = "";
        block.classList.add('d-none');
      }
    }

    async function submitRequest(e) {
      e.preventDefault();
      const btn = document.getElementById('btnSubmit');
      const form = document.getElementById('tripForm');

      if (MY_COMPANIES.length === 0) { showToast("–ù–µ–º–∞—î –¥–æ—Å—Ç—É–ø—É –¥–æ –∫–æ–º–ø–∞–Ω—ñ–π"); return; }

      btn.disabled = true;
      btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';

      const data = {
        userId: USER_ID, userName: USER_NAME,
        company: form.company.value, department: form.department.value, purpose: form.purpose.value,
        comment: form.comment.value,
        dateStart: form.dateStart.value, dateEnd: form.dateEnd.value,
        transportType: form.transportType.value, transportCost: form.transportCost.value,
        peopleCount: form.peopleCount.value, paymentMethod: form.paymentMethod.value,
        paymentCard: form.paymentCard ? form.paymentCard.value : ""
      };

      if (data.paymentMethod === '–ö–∞—Ä—Ç–∞' && !data.paymentCard) {
        showToast("–û–±–µ—Ä—ñ—Ç—å –∫–∞—Ä—Ç—É –¥–ª—è –∑–∞—Ä–∞—Ö—É–≤–∞–Ω–Ω—è");
        btn.disabled = false;
        btn.innerHTML = '–°—Ç–≤–æ—Ä–∏—Ç–∏ –∑–∞—è–≤–∫—É';
        return;
      }

      try {
        const res = await sendPost('createRequest', { data });
        if (res.status === 'success') { showToast(res.message); loadUserHistory(); }
        else { showToast("–ü–æ–º–∏–ª–∫–∞: " + res.message); btn.disabled = false; btn.innerHTML = '–°—Ç–≤–æ—Ä–∏—Ç–∏ –∑–∞—è–≤–∫—É'; }
      } catch (err) { showToast("–ü–æ–º–∏–ª–∫–∞: " + err); btn.disabled = false; btn.innerHTML = '–°—Ç–≤–æ—Ä–∏—Ç–∏ –∑–∞—è–≤–∫—É'; }
    }

    async function loadUserHistory() {
      CURRENT_VIEW = 'history';
      const tabIdx = USER_ROLE === '–ê–¥–º—ñ–Ω' ? 1 : 1;
      setActiveTab(tabIdx);
      document.getElementById('appContent').innerHTML = '<div class="text-center mt-5"><div class="spinner-border text-secondary"></div></div>';

      const res = await fetch(`${API_URL}?action=getUserRequests&userId=${USER_ID}`);
      const data = await res.json();

      if (data.length === 0) { document.getElementById('appContent').innerHTML = '<div class="text-center text-muted mt-5">–Ü—Å—Ç–æ—Ä—ñ—è –ø–æ—Ä–æ–∂–Ω—è</div>'; return; }
      REQUEST_CACHE = {};
      DETAILS_EXPENSE_CACHE = {};
      data.forEach(item => { REQUEST_CACHE[item.reqId] = item; });
      document.getElementById('appContent').innerHTML = data.map(item => renderCard(item, false)).join('');
    }

      async function loadApproverPending() {
        CURRENT_VIEW = 'pending';
        setActiveTab(0);
        document.getElementById('appContent').innerHTML = '<div class="text-center mt-5"><div class="spinner-border text-primary"></div></div>';

      const [resReq, resExp] = await Promise.all([
        fetch(`${API_URL}?action=getAdminRequests&userId=${USER_ID}`),
        fetch(`${API_URL}?action=getPendingExpensesGrouped&userId=${USER_ID}`)
      ]);
      const data = await resReq.json();
      const expensesGrouped = await resExp.json();

      REQUEST_CACHE = {};
      EXPENSE_CACHE = {};
      DETAILS_EXPENSE_CACHE = {};
      data.forEach(item => { REQUEST_CACHE[item.reqId] = item; });

      let html = '';
      if (data.length > 0) {
        html += `<div class="fw-bold text-muted mb-2">–ó–∞—è–≤–∫–∏</div>`;
        html += data.map(item => renderCard(item, true)).join('');
      }
      if (expensesGrouped.length > 0) {
        html += `<div class="fw-bold text-muted mt-4 mb-2">–í–∏—Ç—Ä–∞—Ç–∏ –Ω–∞ –∑–∞—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è</div>`;
        html += expensesGrouped.map(item => renderExpenseGroupCard(item)).join('');
      }
      if (!html) html = '<div class="text-center text-muted mt-5">–ù–µ–º–∞—î –∑–∞—è–≤–æ–∫</div>';
      document.getElementById('appContent').innerHTML = html;
      }

    async function makeDecision(reqId, decision) {
      if (!confirm(decision === 'approve' ? "–ü–æ–≥–æ–¥–∏—Ç–∏?" : "–í—ñ–¥—Ö–∏–ª–∏—Ç–∏?")) return;
      const card = document.getElementById(`card-${reqId}`);
      if (card) card.style.opacity = '0.5';

      try {
        const res = await sendPost('approveRequest', { rowId: reqId, approver: USER_NAME, approverId: USER_ID, decision: decision });
        if (res.status === 'success') { showToast(res.message); loadApproverPending(); }
        else { showToast(res.message); if (card) card.style.opacity = '1'; }
      } catch (err) { showToast("–ü–æ–º–∏–ª–∫–∞: " + err); if (card) card.style.opacity = '1'; }
    }

    function openClarifyModal(reqId) {
      document.getElementById('clarifyReqId').value = reqId;
      document.getElementById('clarifyText').value = '';
      clarifyModalInstance.show();
    }

    async function submitClarifyRequest() {
      const reqId = document.getElementById('clarifyReqId').value;
      const text = document.getElementById('clarifyText').value.trim();
      if (!text) { showToast("–í–∫–∞–∂—ñ—Ç—å —É—Ç–æ—á–Ω–µ–Ω–Ω—è"); return; }
      try {
        const res = await sendPost('requestClarification', { rowId: reqId, adminId: USER_ID, adminName: USER_NAME, question: text });
        if (res.status === 'success') { showToast(res.message); clarifyModalInstance.hide(); loadApproverPending(); }
        else showToast(res.message);
      } catch (err) { showToast("–ü–æ–º–∏–ª–∫–∞: " + err); }
    }

    function openEditModal(reqId) {
      const item = REQUEST_CACHE[reqId];
      if (!item) return;
      document.getElementById('editReqId').value = reqId;
      document.getElementById('editCompany').value = item.company || '';
      document.getElementById('editDept').value = item.dept || '';
      document.getElementById('editPurpose').value = item.purpose || '';
      document.getElementById('editStart').value = item.dStart || '';
      document.getElementById('editEnd').value = item.dEnd || '';
      document.getElementById('editTransType').value = item.transType || '';
      document.getElementById('editTransCost').value = item.transCost || 0;
      document.getElementById('editPeople').value = item.people || 1;
      document.getElementById('editPayment').value = item.payment || '';
      document.getElementById('editCard').value = item.paymentCard || '';
      document.getElementById('editAdminComment').value = '';
      editModalInstance.show();
    }

    async function submitEditApprove() {
      const reqId = document.getElementById('editReqId').value;
      const adminCommentVal = document.getElementById('editAdminComment').value.trim();
      if (!adminCommentVal) { showToast("–ü–æ—Ç—Ä—ñ–±–µ–Ω –∫–æ–º–µ–Ω—Ç–∞—Ä –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞"); return; }
      const data = {
        company: document.getElementById('editCompany').value,
        department: document.getElementById('editDept').value,
        purpose: document.getElementById('editPurpose').value,
        dateStart: document.getElementById('editStart').value,
        dateEnd: document.getElementById('editEnd').value,
        transportType: document.getElementById('editTransType').value,
        transportCost: document.getElementById('editTransCost').value,
        peopleCount: document.getElementById('editPeople').value,
        paymentMethod: document.getElementById('editPayment').value,
        paymentCard: document.getElementById('editCard').value,
        adminComment: adminCommentVal
      };
      try {
        const res = await sendPost('updateAndApproveRequest', { rowId: reqId, approver: USER_NAME, approverId: USER_ID, data });
        if (res.status === 'success') { showToast(res.message); editModalInstance.hide(); loadApproverPending(); }
        else showToast(res.message);
      } catch (err) { showToast("–ü–æ–º–∏–ª–∫–∞: " + err); }
    }

    async function submitClarificationAnswer(reqId) {
      const input = document.getElementById(`clarify-answer-${reqId}`);
      if (!input) return;
      const text = input.value.trim();
      if (!text) { showToast("–í–∫–∞–∂—ñ—Ç—å –≤—ñ–¥–ø–æ–≤—ñ–¥—å"); return; }
      try {
        const res = await sendPost('submitClarificationAnswer', { rowId: reqId, userId: USER_ID, answer: text });
        if (res.status === 'success') { showToast(res.message); loadUserHistory(); }
        else showToast(res.message);
      } catch (err) { showToast("–ü–æ–º–∏–ª–∫–∞: " + err); }
    }

    function toggleExpensesForm(reqId) {
      const block = document.getElementById(`exp-block-${reqId}`);
      if (block) {
        block.classList.toggle('d-none');
        const container = document.getElementById(`exp-rows-${reqId}`);
        if (container && container.children.length === 0) addExpenseRow(reqId);
      }
    }

    function addExpenseRow(reqId) {
      const container = document.getElementById(`exp-rows-${reqId}`);
      if (!container) return;
      const idx = container.children.length + 1;
      const row = document.createElement('div');
      row.className = 'expense-form mb-2';
      row.innerHTML = `
          <div class="mb-2"><input type="text" class="form-control" placeholder="–ù–∞–∑–≤–∞ –≤–∏—Ç—Ä–∞—Ç–∏" data-exp-name required></div>
          <div class="mb-2"><input type="number" class="form-control" placeholder="–°—É–º–∞" data-exp-amount required></div>
          <div class="mb-2"><input type="text" class="form-control" placeholder="–û–ø–∏—Å (–Ω–µ–æ–±–æ–≤'—è–∑–∫–æ–≤–æ)" data-exp-desc></div>
          <div class="mb-2"><input type="text" class="form-control" placeholder="–ü–æ—Å–∏–ª–∞–Ω–Ω—è (–Ω–µ–æ–±–æ–≤'—è–∑–∫–æ–≤–æ)" data-exp-link></div>
          <div class="mb-1"><input type="file" class="form-control" data-exp-files multiple></div>
        `;
      container.appendChild(row);
    }

    async function submitExpenses(reqId) {
      const container = document.getElementById(`exp-rows-${reqId}`);
      if (!container) return;
      const rows = Array.from(container.children);
      const expenses = [];

      for (const row of rows) {
        const name = row.querySelector('[data-exp-name]').value.trim();
        const amount = row.querySelector('[data-exp-amount]').value.trim();
        const description = row.querySelector('[data-exp-desc]').value.trim();
        const link = row.querySelector('[data-exp-link]').value.trim();
        const filesInput = row.querySelector('[data-exp-files]');
        if (!name || !amount) { showToast("–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –Ω–∞–∑–≤—É —ñ —Å—É–º—É"); return; }

        const files = [];
        const fileList = Array.from(filesInput.files || []);
        for (const f of fileList) {
          if (f.size > 5 * 1024 * 1024) { showToast("–§–∞–π–ª –∑–∞–Ω–∞–¥—Ç–æ –≤–µ–ª–∏–∫–∏–π (–º–∞–∫—Å 5MB)"); return; }
          const data = await readFileAsBase64(f);
          files.push({ name: f.name, mime: f.type, data: data });
        }

        expenses.push({ name, amount, description, link, files });
      }

      try {
        const res = await sendPost('submitExpenses', { rowId: reqId, userId: USER_ID, userName: USER_NAME, expenses });
        if (res.status === 'success') { showToast(res.message); loadUserHistory(); }
        else showToast(res.message);
      } catch (err) { showToast("–ü–æ–º–∏–ª–∫–∞: " + err); }
    }

    function readFileAsBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => {
          const base64 = (reader.result || '').toString().split(',')[1] || '';
          resolve(base64);
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    async function decideExpenseBatch(reqId, expenseIds, decision) {
      if (!expenseIds || expenseIds.length === 0) return;
      if (!confirm(decision === 'approve' ? "–ü–æ–≥–æ–¥–∏—Ç–∏ –≤—Å—ñ –≤–∏—Ç—Ä–∞—Ç–∏?" : "–í—ñ–¥—Ö–∏–ª–∏—Ç–∏ –≤—Å—ñ –≤–∏—Ç—Ä–∞—Ç–∏?")) return;
      const card = document.getElementById(`exp-group-${reqId}`);
      if (card) card.style.opacity = '0.5';
      try {
        const res = await sendPost('decideExpensesBatch', { expenseIds, approver: USER_NAME, decision });
        if (res.status === 'success') { showToast(res.message); loadApproverPending(); }
        else { showToast(res.message); if (card) card.style.opacity = '1'; }
      } catch (err) { showToast("–ü–æ–º–∏–ª–∫–∞: " + err); if (card) card.style.opacity = '1'; }
    }

    function renderCard(item, isApprover) {
      let borderClass = 'marker-gray';
      if (item.company.includes('Blue Bird')) borderClass = 'marker-blue';
      if (item.company.includes('Flash')) borderClass = 'marker-flash';
      if (item.company.includes('–ü—Ä–æ—Ñ—ñ–°—Ç—Ä–æ–π')) borderClass = 'marker-profi';
      if (item.status === '–ü–æ—Ç—Ä–µ–±—É—î —É—Ç–æ—á–Ω–µ–Ω–Ω—è') borderClass = 'marker-clarify';

      const totalSum = parseFloat(item.dailyTotal) + parseFloat(item.transCost);
      const cardId = `card-${item.reqId}`;

      let footerHtml = '';
      const isActionable = isApprover && (item.status === '–ù–æ–≤–∞' || item.status === '–£—Ç–æ—á–Ω–µ–Ω–æ' || item.status === '–ü–æ—Ç—Ä–µ–±—É—î —É—Ç–æ—á–Ω–µ–Ω–Ω—è');
      if (isActionable) {
        footerHtml = `
            <div class="d-flex gap-2 mt-3 pt-2 border-top">
                <button class="btn btn-outline-danger flex-grow-1" onclick="event.stopPropagation(); makeDecision('${item.reqId}', 'reject')">–í—ñ–¥—Ö–∏–ª–∏—Ç–∏</button>
                <button class="btn btn-success flex-grow-1" onclick="event.stopPropagation(); makeDecision('${item.reqId}', 'approve')">–ü–æ–≥–æ–¥–∏—Ç–∏</button>
            </div>`;
        footerHtml += `
            <div class="d-flex gap-2 mt-2">
                <button class="btn btn-outline-warning flex-grow-1" onclick="event.stopPropagation(); openClarifyModal('${item.reqId}')">–ü–æ—Ç—Ä–µ–±—É—î —É—Ç–æ—á–Ω–µ–Ω–Ω—è</button>
                <button class="btn btn-outline-primary flex-grow-1" onclick="event.stopPropagation(); openEditModal('${item.reqId}')">–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ —Ç–∞ –ø–æ–≥–æ–¥–∏—Ç–∏</button>
            </div>`;
      } else {
        if (item.status === '–ü–æ–≥–æ–¥–∂–µ–Ω–æ') footerHtml = `<div class="mt-2 text-success small text-end fw-bold"><i class="bi bi-check2-all"></i> –ü–æ–≥–æ–¥–∏–≤: ${item.approver}</div>`;
        if (item.status === '–í—ñ–¥—Ö–∏–ª–µ–Ω–æ') footerHtml = `<div class="mt-2 text-danger small text-end fw-bold"><i class="bi bi-x-circle"></i> –í—ñ–¥—Ö–∏–ª–∏–≤: ${item.approver}</div>`;
      }

      let clarifyHtml = '';
      if (item.clarifyQuestion) {
        clarifyHtml += `<div class="mt-2 small text-warning"><i class="bi bi-question-circle"></i> –£—Ç–æ—á–Ω–µ–Ω–Ω—è: ${item.clarifyQuestion}</div>`;
      }
      if (item.clarifyAnswer) {
        clarifyHtml += `<div class="mt-1 small text-info"><i class="bi bi-chat-left-text"></i> –í—ñ–¥–ø–æ–≤—ñ–¥—å: ${item.clarifyAnswer}</div>`;
      }

      let editHtml = '';
      if (item.editSummary) {
        editHtml = `<div class="mt-2 small text-muted"><i class="bi bi-pencil-square"></i> –ó–º—ñ–Ω–∏: ${item.editSummary}</div>`;
      }

      const userComment = item.userComment ? `<div class="mt-2 small text-muted"><i class="bi bi-chat-quote"></i> –ö–æ–º–µ–Ω—Ç–∞—Ä: ${item.userComment}</div>` : '';
      const adminComment = item.adminComment ? `<div class="mt-1 small text-muted"><i class="bi bi-chat-right-text"></i> –ö–æ–º–µ–Ω—Ç–∞—Ä –∞–¥–º—ñ–Ω–∞: ${item.adminComment}</div>` : '';
      const paymentCard = item.paymentCard ? ` (${item.paymentCard})` : '';

      let expensesBadge = '';
      if (item.pendingExpenses && parseInt(item.pendingExpenses) > 0) {
        expensesBadge = `<div class="mt-2 small text-primary"><i class="bi bi-receipt"></i> –û—á—ñ–∫—É—é—Ç—å –≤–∏—Ç—Ä–∞—Ç–∏: ${item.pendingExpenses}</div>`;
      }

      let clarifyAnswerHtml = '';
      if (!isApprover && item.status === '–ü–æ—Ç—Ä–µ–±—É—î —É—Ç–æ—á–Ω–µ–Ω–Ω—è') {
        clarifyAnswerHtml = `
            <div class="mt-2" onclick="event.stopPropagation()">
              <textarea class="form-control mb-2" id="clarify-answer-${item.reqId}" rows="2" placeholder="–í–∞—à–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—å..."></textarea>
              <button class="btn btn-warning w-100" onclick="event.stopPropagation(); submitClarificationAnswer('${item.reqId}')">–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ —É—Ç–æ—á–Ω–µ–Ω–Ω—è</button>
            </div>`;
      }

      let expenseHtml = '';
      if (!isApprover && item.status === '–ü–æ–≥–æ–¥–∂–µ–Ω–æ') {
        expenseHtml = `
            <div class="mt-2" onclick="event.stopPropagation()">
              <button class="btn btn-outline-primary w-100" onclick="event.stopPropagation(); toggleExpensesForm('${item.reqId}')">–î–æ–¥–∞—Ç–∏ –≤–∏—Ç—Ä–∞—Ç–∏</button>
              <div class="mt-2 d-none" id="exp-block-${item.reqId}">
                <div id="exp-rows-${item.reqId}"></div>
                <div class="d-flex gap-2">
                  <button class="btn btn-light flex-grow-1" onclick="event.stopPropagation(); addExpenseRow('${item.reqId}')">+ –î–æ–¥–∞—Ç–∏ —â–µ</button>
                  <button class="btn btn-success flex-grow-1" onclick="event.stopPropagation(); submitExpenses('${item.reqId}')">–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏</button>
                </div>
              </div>
            </div>`;
      }

      return `
          <div class="card p-3 ${borderClass}" id="${cardId}" onclick="openDetailsModal('${item.reqId}')">
             <div class="d-flex justify-content-between mb-2"><span class="badge bg-light text-dark border">${item.company}</span>${getStatusBadge(item.status)}</div>
             ${isApprover ? `<h6 class="fw-bold mb-0">${item.userName}</h6><small class="text-muted mb-2 d-block">${item.dept}</small>` : ''}
             <div class="fw-bold fs-5 mb-1">${item.purpose}</div>
             <div class="text-muted small mb-2"><i class="bi bi-calendar"></i> ${item.dStart} ‚Äî ${item.dEnd}</div>
             <div class="bg-light rounded p-2 small">
                <div class="d-flex justify-content-between"><span>–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç:</span> <strong>${item.transType} (${item.transCost})</strong></div>
                <div class="d-flex justify-content-between"><span>–î–æ–±–æ–≤—ñ (${item.people} —á–æ–ª):</span> <strong>${item.dailyTotal}</strong></div>
                <div class="d-flex justify-content-between"><span>–û–ø–ª–∞—Ç–∞:</span> <strong>${item.payment}${paymentCard}</strong></div>
                <div class="d-flex justify-content-between border-top mt-1 pt-1 fw-bold text-dark"><span>–†–ê–ó–û–ú:</span> <span>${totalSum} ‚Ç¥</span></div>
             </div>
             ${userComment}
             ${adminComment}
             ${expensesBadge}
             ${editHtml}
             ${clarifyHtml}
             ${clarifyAnswerHtml}
             ${expenseHtml}
             ${footerHtml}
          </div>`;
    }

    function showToast(msg) { document.getElementById('toastMessage').innerText = msg; toastInstance.show(); }
    function getStatusBadge(s) {
      if (s === '–ù–æ–≤–∞') return '<span class="badge-status st-new">–ù–æ–≤–∞</span>';
      if (s === '–ü–æ–≥–æ–¥–∂–µ–Ω–æ') return '<span class="badge-status st-approved">–ü–æ–≥–æ–¥–∂–µ–Ω–æ</span>';
      if (s === '–ü–æ—Ç—Ä–µ–±—É—î —É—Ç–æ—á–Ω–µ–Ω–Ω—è') return '<span class="badge-status st-clarify">–ü–æ—Ç—Ä–µ–±—É—î —É—Ç–æ—á–Ω–µ–Ω–Ω—è</span>';
      if (s === '–£—Ç–æ—á–Ω–µ–Ω–æ') return '<span class="badge-status st-clarified">–£—Ç–æ—á–Ω–µ–Ω–æ</span>';
      return '<span class="badge-status st-rejected">–í—ñ–¥—Ö–∏–ª–µ–Ω–æ</span>';
    }

    function renderExpenseCard(item) {
      const files = item.fileUrls ? item.fileUrls.split(',').filter(Boolean).map(u => `<a href="${u.trim()}" target="_blank">—Ñ–∞–π–ª</a>`).join(', ') : '';
      return `
          <div class="card p-3 marker-gray" id="exp-${item.expenseId}">
            <div class="d-flex justify-content-between mb-2">
              <span class="badge bg-light text-dark border">${item.company}</span>
              <span class="badge-status st-new">–í–∏—Ç—Ä–∞—Ç–∏</span>
            </div>
            <div class="fw-bold">${item.userName}</div>
            <div class="text-muted small mb-2">–ó–∞—è–≤–∫–∞: ${item.reqId}</div>
            <div class="bg-light rounded p-2 small">
              <div class="d-flex justify-content-between"><span>–ù–∞–∑–≤–∞:</span> <strong>${item.name}</strong></div>
              <div class="d-flex justify-content-between"><span>–°—É–º–∞:</span> <strong>${item.amount}</strong></div>
              ${item.description ? `<div class="mt-1">${item.description}</div>` : ''}
              ${item.link ? `<div class="mt-1"><a href="${item.link}" target="_blank">${item.link}</a></div>` : ''}
              ${files ? `<div class="mt-1">–§–∞–π–ª–∏: ${files}</div>` : ''}
            </div>
            <div class="d-flex gap-2 mt-3 pt-2 border-top">
              <button class="btn btn-outline-danger flex-grow-1" onclick="decideExpense('${item.expenseId}', 'reject')">–í—ñ–¥—Ö–∏–ª–∏—Ç–∏</button>
              <button class="btn btn-success flex-grow-1" onclick="decideExpense('${item.expenseId}', 'approve')">–ü–æ–≥–æ–¥–∏—Ç–∏</button>
            </div>
          </div>`;
    }

    function renderExpenseGroupCard(group) {
      const total = group.items.reduce((sum, i) => sum + (parseFloat(i.amount) || 0), 0);
      const ids = group.items.map(i => i.expenseId);
      const itemsHtml = group.items.map(i => `
        <div class="d-flex justify-content-between small">
          <span>${i.name}</span><strong>${i.amount}</strong>
        </div>
      `).join('');

      return `
        <div class="card p-3 marker-gray" id="exp-group-${group.reqId}" onclick="openDetailsModal('${group.reqId}')">
          <div class="d-flex justify-content-between mb-2">
            <span class="badge bg-light text-dark border">${group.company}</span>
            <span class="badge-status st-new">–í–∏—Ç—Ä–∞—Ç–∏</span>
          </div>
          <div class="fw-bold">${group.userName}</div>
          <div class="text-muted small mb-2">${group.purpose} ‚Ä¢ ${group.dStart} ‚Äî ${group.dEnd}</div>
          <div class="bg-light rounded p-2 small">
            ${itemsHtml}
            <div class="d-flex justify-content-between border-top mt-1 pt-1 fw-bold text-dark">
              <span>–†–∞–∑–æ–º:</span><span>${total} ‚Ç¥</span>
            </div>
          </div>
          <div class="d-flex gap-2 mt-3 pt-2 border-top">
            <button class="btn btn-outline-danger flex-grow-1" onclick="event.stopPropagation(); decideExpenseBatch('${group.reqId}', ${JSON.stringify(ids)}, 'reject')">–í—ñ–¥—Ö–∏–ª–∏—Ç–∏</button>
            <button class="btn btn-success flex-grow-1" onclick="event.stopPropagation(); decideExpenseBatch('${group.reqId}', ${JSON.stringify(ids)}, 'approve')">–ü–æ–≥–æ–¥–∏—Ç–∏</button>
          </div>
        </div>`;
    }

    async function openDetailsModal(reqId) {
      const req = REQUEST_CACHE[reqId];
      if (!req) { showToast("–î–∞–Ω—ñ –∑–∞—è–≤–∫–∏ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ"); return; }
      document.getElementById('detailsBody').innerHTML = '<div class="text-center text-muted">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>';
      detailsModalInstance.show();

      let expenses = DETAILS_EXPENSE_CACHE[reqId];
      if (!expenses) {
        try {
          const res = await fetch(`${API_URL}?action=getExpensesByReqId&userId=${USER_ID}&reqId=${reqId}`);
          expenses = await res.json();
          if (expenses && expenses.error) expenses = [];
          DETAILS_EXPENSE_CACHE[reqId] = expenses;
        } catch (e) {
          expenses = [];
        }
      }
      document.getElementById('detailsBody').innerHTML = renderDetailsBody(req, expenses);
    }

    function renderDetailsBody(req, expenses) {
      const totalSum = (parseFloat(req.dailyTotal) || 0) + (parseFloat(req.transCost) || 0);
      const paymentCard = req.paymentCard ? ` (${req.paymentCard})` : '';
      const edits = req.editSummary ? `<div class="mt-2"><strong>–ó–º—ñ–Ω–∏:</strong> ${req.editSummary}</div>` : '';
      const adminComment = req.adminComment ? `<div class="mt-2"><strong>–ö–æ–º–µ–Ω—Ç–∞—Ä –∞–¥–º—ñ–Ω–∞:</strong> ${req.adminComment}</div>` : '';
      const userComment = req.userComment ? `<div class="mt-2"><strong>–ö–æ–º–µ–Ω—Ç–∞—Ä:</strong> ${req.userComment}</div>` : '';
      const clarify = req.clarifyQuestion ? `
        <div class="mt-2"><strong>–£—Ç–æ—á–Ω–µ–Ω–Ω—è:</strong> ${req.clarifyQuestion}</div>
        ${req.clarifyAnswer ? `<div class="mt-1"><strong>–í—ñ–¥–ø–æ–≤—ñ–¥—å:</strong> ${req.clarifyAnswer}</div>` : ''}
        ${req.clarifyByName ? `<div class="mt-1"><strong>–ó–∞–ø—Ä–æ—Å–∏–≤:</strong> ${req.clarifyByName}</div>` : ''}
      ` : '';

      const expensesHtml = (expenses && expenses.length > 0)
        ? expenses.map(e => {
            const files = e.fileUrls ? e.fileUrls.split(',').filter(Boolean).map(u => `<a href="${u.trim()}" target="_blank">—Ñ–∞–π–ª</a>`).join(', ') : '';
            return `
              <div class="border rounded p-2 mb-2">
                <div class="d-flex justify-content-between"><strong>${e.name}</strong><span>${e.amount}</span></div>
                ${e.description ? `<div class="small text-muted">${e.description}</div>` : ''}
                ${e.link ? `<div class="small"><a href="${e.link}" target="_blank">${e.link}</a></div>` : ''}
                ${files ? `<div class="small">–§–∞–π–ª–∏: ${files}</div>` : ''}
                <div class="small text-muted">–°—Ç–∞—Ç—É—Å: ${e.status}${e.approver ? ` ‚Ä¢ ${e.approver}` : ''}${e.decidedAt ? ` ‚Ä¢ ${e.decidedAt}` : ''}</div>
              </div>
            `;
          }).join('')
        : '<div class="text-muted small">–ù–µ–º–∞—î –≤–∏—Ç—Ä–∞—Ç</div>';

      return `
        <div class="mb-2">
          <div class="d-flex justify-content-between mb-1"><span class="badge bg-light text-dark border">${req.company}</span>${getStatusBadge(req.status)}</div>
          <div class="fw-bold">${req.purpose}</div>
          <div class="small text-muted">${req.dStart} ‚Äî ${req.dEnd}</div>
        </div>
        <div class="bg-light rounded p-2 small mb-2">
          <div class="d-flex justify-content-between"><span>–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á:</span><strong>${req.userName}</strong></div>
          <div class="d-flex justify-content-between"><span>–í—ñ–¥–¥—ñ–ª:</span><strong>${req.dept}</strong></div>
          <div class="d-flex justify-content-between"><span>–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç:</span><strong>${req.transType} (${req.transCost})</strong></div>
          <div class="d-flex justify-content-between"><span>–î–æ–±–æ–≤—ñ (${req.people} —á–æ–ª):</span><strong>${req.dailyTotal}</strong></div>
          <div class="d-flex justify-content-between"><span>–û–ø–ª–∞—Ç–∞:</span><strong>${req.payment}${paymentCard}</strong></div>
          <div class="d-flex justify-content-between border-top mt-1 pt-1 fw-bold"><span>–†–ê–ó–û–ú:</span><span>${totalSum} ‚Ç¥</span></div>
        </div>
        <div class="small text-muted">
          <div>–°—Ç–≤–æ—Ä–µ–Ω–æ: ${req.created}</div>
          ${req.updatedAt ? `<div>–û–Ω–æ–≤–ª–µ–Ω–æ: ${req.updatedAt}</div>` : ''}
          ${req.editedBy ? `<div>–†–µ–¥–∞–∫—Ç–æ—Ä: ${req.editedBy}</div>` : ''}
          ${req.approver ? `<div>–ü–æ–≥–æ–¥–∏–≤: ${req.approver}</div>` : ''}
        </div>
        ${userComment}
        ${adminComment}
        ${edits}
        ${clarify}
        <div class="mt-3">
          <div class="fw-bold mb-1">–î–æ–¥–∞—Ç–∫–æ–≤—ñ –≤–∏—Ç—Ä–∞—Ç–∏</div>
          ${expensesHtml}
        </div>
      `;
    }
  </script>
</body>

</html>
