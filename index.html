<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>–í—ñ–¥—Ä—è–¥–∂–µ–Ω–Ω—è</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    
    <style>
      :root { --primary-color: #0d6efd; --bg-color: #f0f2f5; }
      body { padding: 15px 0px 15px 0px; background-color: var(--bg-color); font-family: -apple-system, system-ui, sans-serif; padding-bottom: 90px; }
      input, select, textarea { font-size: 16px !important; }
      
      .card { border-radius: 16px; border: none; box-shadow: 0 2px 12px rgba(0,0,0,0.04); margin-bottom: 12px; transition: opacity 0.3s; }
      
      .nav-pills { background: #fff; padding: 5px; border-radius: 14px; margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
      .nav-pills .nav-link { border-radius: 10px; color: #6c757d; font-weight: 600; font-size: 0.9rem; padding: 10px; }
      .nav-pills .nav-link.active { background-color: var(--primary-color); color: #fff; }

      .badge-status { font-weight: 600; padding: 6px 12px; border-radius: 8px; font-size: 0.75rem; text-transform: uppercase; }
      .st-new { background-color: #e3f2fd; color: #0d47a1; }
      .st-approved { background-color: #d1e7dd; color: #0f5132; }
      .st-rejected { background-color: #f8d7da; color: #842029; }

      .marker-flash { border-left: 5px solid #ffc107; }
      .marker-blue { border-left: 5px solid #0d6efd; }
      .marker-profi { border-left: 5px solid #6610f2; }
      .marker-gray { border-left: 5px solid #6c757d; }

      .total-box { background: #f8f9fa; border-radius: 12px; padding: 15px; border: 1px dashed #adb5bd; }
      .toast-container { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 1060; width: 97%; max-width: 400px; }
      .toast { background: #333; color: #fff; border-radius: 12px; }
    </style>
  </head>
  <body>

    <div class="container" style="max-width: 600px;">
      
      <!-- Header -->
      <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
          <small class="text-muted text-uppercase fw-bold" style="font-size: 0.65rem;">–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á</small>
          <div class="fw-bold fs-5 text-dark" id="ui-userName">...</div>
        </div>
        <div>
           <span class="badge bg-light text-dark border"><i class="bi bi-shield-lock"></i> <span id="ui-userRole">...</span></span>
           <button class="btn btn-sm btn-white text-primary ms-1" onclick="forceReload()">
             <i class="bi bi-arrow-clockwise fs-5"></i>
           </button>
        </div>
      </div>

      <ul class="nav nav-pills nav-fill" id="pills-tab"></ul>

      <div id="appContent">
        <div class="text-center mt-5 pt-4">
          <div class="spinner-border text-primary"></div>
        </div>
      </div>
    </div>

    <!-- Toast -->
    <div class="toast-container">
      <div id="liveToast" class="toast align-items-center border-0 shadow" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
          <div class="toast-body d-flex align-items-center">
            <i class="bi bi-info-circle-fill me-2 fs-5"></i>
            <span id="toastMessage">...</span>
          </div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      const API_URL = "https://script.google.com/macros/s/AKfycbx0v1qTvhc7VIjnEBfSTTGUT2jW8ITEzF6rJ4_ENgKzGLbC2MGiUKFTgUuOnG9sWgr-/exec"; 

      const urlParams = new URLSearchParams(window.location.search);
      const USER_ID = urlParams.get('userid');
      
      let USER_NAME = "";
      let USER_ROLE = "";
      let MY_COMPANIES = [];
      let DEPARTMENTS = [];
      let CURRENT_VIEW = '';
      let toastInstance;

      window.onload = async function() {
        toastInstance = new bootstrap.Toast(document.getElementById('liveToast'), { delay: 3000 });
        
        if (!USER_ID) {
           document.getElementById('appContent').innerHTML = '<div class="alert alert-danger text-center">–ù–µ –≤–∫–∞–∑–∞–Ω–æ User ID</div>';
           return;
        }

        // --- –ö–õ–ò–ï–ù–¢–°–ö–û–ï –ö–≠–®–ò–†–û–í–ê–ù–ò–ï ---
        // 1. –ü—Ä–æ–±—É–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç—å—Å—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –∏–∑ –ø–∞–º—è—Ç–∏ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
        const cachedUser = localStorage.getItem('trip_user_' + USER_ID);
        const cachedDepts = localStorage.getItem('trip_depts');

        if (cachedUser && cachedDepts) {
            console.log("Loaded from local cache");
            applyUserData(JSON.parse(cachedUser));
            DEPARTMENTS = JSON.parse(cachedDepts);
            initApp();
            
            // –í —Ñ–æ–Ω–µ –æ–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ (—á—Ç–æ–±—ã –µ—Å–ª–∏ –ø—Ä–∞–≤–∞ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å, —é–∑–µ—Ä —É–∑–Ω–∞–ª –æ–± —ç—Ç–æ–º)
            fetchUserData(true); 
        } else {
            // –ï—Å–ª–∏ –∫—ç—à–∞ –Ω–µ—Ç, –≥—Ä—É–∑–∏–º —Å —Å–µ—Ä–≤–µ—Ä–∞
            await fetchUserData(false);
        }
      };

      async function fetchUserData(inBackground) {
         try {
            const [resUser, resDep] = await Promise.all([
                fetch(`${API_URL}?action=getUserInfo&userId=${USER_ID}`),
                fetch(`${API_URL}?action=getDepartments`)
            ]);

            const userData = await resUser.json();
            const deptData = await resDep.json();

            if (userData.error) {
                if(!inBackground) document.getElementById('appContent').innerHTML = `<div class="alert alert-danger text-center">${userData.error}</div>`;
                return;
            }

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ø–∞–º—è—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω–∞
            localStorage.setItem('trip_user_' + USER_ID, JSON.stringify(userData));
            localStorage.setItem('trip_depts', JSON.stringify(deptData));

            // –ï—Å–ª–∏ —ç—Ç–æ –Ω–µ —Ñ–æ–Ω–æ–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ, –ø—Ä–∏–º–µ–Ω—è–µ–º –∏ —Ä–µ–Ω–¥–µ—Ä–∏–º
            if (!inBackground) {
                applyUserData(userData);
                DEPARTMENTS = deptData;
                initApp();
            } else {
                // –ï—Å–ª–∏ —Ñ–æ–Ω–æ–≤–æ–µ - –ø—Ä–æ—Å—Ç–æ –æ–±–Ω–æ–≤–ª—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
                applyUserData(userData);
                DEPARTMENTS = deptData;
            }
         } catch(e) {
            if(!inBackground) showToast("–ü–æ–º–∏–ª–∫–∞ –∑'—î–¥–Ω–∞–Ω–Ω—è: " + e);
         }
      }

      function applyUserData(data) {
          USER_NAME = data.name;
          USER_ROLE = data.role;
          const raw = data.company || "";
          MY_COMPANIES = raw.split(',').map(c => c.trim()).filter(c => c.length > 0);
          
          document.getElementById('ui-userName').innerText = USER_NAME;
          document.getElementById('ui-userRole').innerText = USER_ROLE;
      }

      function forceReload() {
          localStorage.removeItem('trip_user_' + USER_ID); // –ß–∏—Å—Ç–∏–º –∫—ç—à
          localStorage.removeItem('trip_depts');
          location.reload();
      }

      function initApp() {
        const nav = document.getElementById('pills-tab');
        // –ï—Å–ª–∏ –º–µ–Ω—é —É–∂–µ –µ—Å—Ç—å, –Ω–µ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –µ–≥–æ (—á—Ç–æ–±—ã –Ω–µ –º–æ—Ä–≥–∞–ª–æ –ø—Ä–∏ —Ñ–æ–Ω–æ–≤–æ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏)
        if (nav.innerHTML.trim() === "") {
            if (USER_ROLE === '–ê–¥–º—ñ–Ω') {
              nav.innerHTML = `
                <li class="nav-item"><a class="nav-link active" onclick="loadApproverPending()">‚ö° –ü–æ–≥–æ–¥–∏—Ç–∏</a></li>
                <li class="nav-item"><a class="nav-link" onclick="loadUserHistory()">üìÇ –ú–æ—ó</a></li>
                <li class="nav-item"><a class="nav-link" onclick="loadUserCreate()">‚ûï –°—Ç–≤–æ—Ä–∏—Ç–∏</a></li>
              `;
              loadApproverPending();
            } else {
              nav.innerHTML = `
                <li class="nav-item"><a class="nav-link active" onclick="loadUserCreate()">‚ûï –°—Ç–≤–æ—Ä–∏—Ç–∏</a></li>
                <li class="nav-item"><a class="nav-link" onclick="loadUserHistory()">üìã –Ü—Å—Ç–æ—Ä—ñ—è</a></li>
              `;
              loadUserCreate();
            }
        }
      }

      function refreshTab() {
        if(CURRENT_VIEW === 'create') loadUserCreate();
        else if(CURRENT_VIEW === 'history') loadUserHistory();
        else if(CURRENT_VIEW === 'pending') loadApproverPending();
      }

      function setActiveTab(idx) {
        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
        const target = document.querySelectorAll('.nav-link')[idx];
        if(target) target.classList.add('active');
      }

      async function sendPost(action, data) {
         const response = await fetch(API_URL, {
            method: 'POST',
            body: JSON.stringify({ action: action, ...data })
         });
         return await response.json();
      }

      // === CREATE FORM ===
      function loadUserCreate() {
        CURRENT_VIEW = 'create';
        const tabIdx = USER_ROLE === '–ê–¥–º—ñ–Ω' ? 2 : 0;
        setActiveTab(tabIdx);

        const deptOpts = DEPARTMENTS.map(d => `<option value="${d}">${d}</option>`).join('');
        let companyOpts = MY_COMPANIES.length > 0 
           ? MY_COMPANIES.map(c => `<option value="${c}">${c}</option>`).join('')
           : `<option disabled selected>–ù–µ–º–∞—î –¥–æ—Å—Ç—É–ø—É –¥–æ –∫–æ–º–ø–∞–Ω—ñ–π</option>`;

        const today = new Date().toISOString().split('T')[0];

        document.getElementById('appContent').innerHTML = `
          <div class="card p-4 shadow-sm animate__animated animate__fadeIn">
            <form id="tripForm" onsubmit="submitRequest(event)">
              <div class="mb-3"><label class="small text-muted fw-bold">–ö–æ–º–ø–∞–Ω—ñ—è</label><select class="form-select fw-bold" name="company" required>${companyOpts}</select></div>
              <div class="mb-3"><label class="small text-muted fw-bold">–í—ñ–¥–¥—ñ–ª</label><select class="form-select" name="department" required><option value="" disabled selected>–û–±–µ—Ä—ñ—Ç—å –≤—ñ–¥–¥—ñ–ª...</option>${deptOpts}</select></div>
              <div class="mb-3"><label class="small text-muted fw-bold">–ú–µ—Ç–∞ –≤—ñ–¥—Ä—è–¥–∂–µ–Ω–Ω—è</label><input type="text" class="form-control" name="purpose" placeholder="–ù–∞–ø—Ä: –¢—Ä–µ–Ω—ñ–Ω–≥, –í–∏—Å—Ç–∞–≤–∫–∞..." required></div>
              <div class="row g-2 mb-3">
                <div class="col-6"><label class="small text-muted fw-bold">–î–∞—Ç–∞ –ø–æ—á–∞—Ç–∫—É</label><input type="date" class="form-control" name="dateStart" id="dStart" min="${today}" onchange="calcTotal()" required></div>
                <div class="col-6"><label class="small text-muted fw-bold">–î–∞—Ç–∞ –∫—ñ–Ω—Ü—è</label><input type="date" class="form-control" name="dateEnd" id="dEnd" min="${today}" onchange="calcTotal()" required></div>
              </div>
              <div class="mb-3">
                <label class="small text-muted fw-bold">–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç</label>
                <select class="form-select mb-2" name="transportType" required><option value="–ü–æ—ó–∑–¥">–ü–æ—ó–∑–¥</option><option value="–ê–≤—Ç–æ (–ë–µ–Ω–∑–∏–Ω)">–ê–≤—Ç–æ (–ë–µ–Ω–∑–∏–Ω)</option><option value="–ê–≤—Ç–æ–±—É—Å">–ê–≤—Ç–æ–±—É—Å</option><option value="–õ—ñ—Ç–∞–∫">–õ—ñ—Ç–∞–∫</option></select>
                <input type="number" class="form-control" name="transportCost" id="tCost" placeholder="–í–∞—Ä—Ç—ñ—Å—Ç—å –∫–≤–∏—Ç–∫—ñ–≤ (–≥—Ä–Ω)" oninput="calcTotal()" required>
              </div>
              <div class="row g-2 mb-3">
                 <div class="col-6"><label class="small text-muted fw-bold">–õ—é–¥–µ–π</label><input type="number" class="form-control" name="peopleCount" id="pCount" value="1" min="1" oninput="calcTotal()" required></div>
                 <div class="col-6"><label class="small text-muted fw-bold">–û–ø–ª–∞—Ç–∞</label><select class="form-select" name="paymentMethod"><option value="–ö–∞—Ä—Ç–∞">üí≥ –ù–∞ –∫–∞—Ä—Ç—É</option><option value="–ì–æ—Ç—ñ–≤–∫–∞">üíµ –ì–æ—Ç—ñ–≤–∫–∞</option></select></div>
              </div>
              <div class="total-box mb-3">
                <div class="d-flex justify-content-between mb-1"><small class="text-muted">–î–æ–±–æ–≤—ñ (700 ‚Ç¥):</small><small class="fw-bold" id="calcDaily">0 ‚Ç¥</small></div>
                <div class="d-flex justify-content-between align-items-center border-top pt-2 mt-2"><span class="fw-bold text-dark">–í–°–¨–û–ì–û:</span><span class="fs-5 fw-bold text-primary" id="calcTotal">0 ‚Ç¥</span></div>
              </div>
              <button type="submit" id="btnSubmit" class="btn btn-primary w-100 py-3 rounded-pill fw-bold shadow">–°—Ç–≤–æ—Ä–∏—Ç–∏ –∑–∞—è–≤–∫—É</button>
            </form>
          </div>`;
      }

      function calcTotal() {
        const dS = document.getElementById('dStart').value;
        const dE = document.getElementById('dEnd').value;
        const cost = parseFloat(document.getElementById('tCost').value) || 0;
        const people = parseInt(document.getElementById('pCount').value) || 1;

        if(dS && dE) {
          const start = new Date(dS);
          const end = new Date(dE);
          if (start > end) {
             document.getElementById('calcDaily').innerText = '-';
             document.getElementById('calcTotal').innerText = '-';
             return;
          }
          const diffDays = Math.ceil(Math.abs(end - start) / (86400000)) + 1; 
          const dailySum = diffDays * 700 * people;
          document.getElementById('calcDaily').innerText = dailySum.toLocaleString() + ' ‚Ç¥';
          document.getElementById('calcTotal').innerText = (dailySum + cost).toLocaleString() + ' ‚Ç¥';
        }
      }

      async function submitRequest(e) {
        e.preventDefault();
        const btn = document.getElementById('btnSubmit');
        const form = document.getElementById('tripForm');
        
        if (MY_COMPANIES.length === 0) { showToast("–ù–µ–º–∞—î –¥–æ—Å—Ç—É–ø—É –¥–æ –∫–æ–º–ø–∞–Ω—ñ–π"); return; }
        
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';

        const data = {
           userId: USER_ID, userName: USER_NAME,
           company: form.company.value, department: form.department.value, purpose: form.purpose.value,
           dateStart: form.dateStart.value, dateEnd: form.dateEnd.value,
           transportType: form.transportType.value, transportCost: form.transportCost.value,
           peopleCount: form.peopleCount.value, paymentMethod: form.paymentMethod.value
        };

        try {
           const res = await sendPost('createRequest', { data });
           if (res.status === 'success') { showToast(res.message); loadUserHistory(); }
           else { showToast("–ü–æ–º–∏–ª–∫–∞: " + res.message); btn.disabled = false; btn.innerHTML = '–°—Ç–≤–æ—Ä–∏—Ç–∏ –∑–∞—è–≤–∫—É'; }
        } catch(err) { showToast("–ü–æ–º–∏–ª–∫–∞: " + err); btn.disabled = false; btn.innerHTML = '–°—Ç–≤–æ—Ä–∏—Ç–∏ –∑–∞—è–≤–∫—É'; }
      }

      async function loadUserHistory() {
        CURRENT_VIEW = 'history';
        const tabIdx = USER_ROLE === '–ê–¥–º—ñ–Ω' ? 1 : 1;
        setActiveTab(tabIdx);
        document.getElementById('appContent').innerHTML = '<div class="text-center mt-5"><div class="spinner-border text-secondary"></div></div>';

        const res = await fetch(`${API_URL}?action=getUserRequests&userId=${USER_ID}`);
        const data = await res.json();
        
        if(data.length === 0) { document.getElementById('appContent').innerHTML = '<div class="text-center text-muted mt-5">–Ü—Å—Ç–æ—Ä—ñ—è –ø–æ—Ä–æ–∂–Ω—è</div>'; return; }
        document.getElementById('appContent').innerHTML = data.map(item => renderCard(item, false)).join('');
      }

      async function loadApproverPending() {
        CURRENT_VIEW = 'pending';
        setActiveTab(0);
        document.getElementById('appContent').innerHTML = '<div class="text-center mt-5"><div class="spinner-border text-primary"></div></div>';

        const res = await fetch(`${API_URL}?action=getPendingRequests&userId=${USER_ID}`);
        const data = await res.json();
        
        if(data.length === 0) { document.getElementById('appContent').innerHTML = '<div class="text-center text-muted mt-5">–ù–µ–º–∞—î –∑–∞—è–≤–æ–∫</div>'; return; }
        document.getElementById('appContent').innerHTML = data.map(item => renderCard(item, true)).join('');
      }

      async function makeDecision(reqId, decision) {
         if(!confirm(decision === 'approve' ? "–ü–æ–≥–æ–¥–∏—Ç–∏?" : "–í—ñ–¥—Ö–∏–ª–∏—Ç–∏?")) return;
         const card = document.getElementById(`card-${reqId}`);
         if(card) card.style.opacity = '0.5';

         try {
            const res = await sendPost('approveRequest', { rowId: reqId, approver: USER_NAME, decision: decision });
            if(res.status === 'success') { showToast(res.message); loadApproverPending(); }
            else { showToast(res.message); if(card) card.style.opacity = '1'; }
         } catch(err) { showToast("–ü–æ–º–∏–ª–∫–∞: "+err); if(card) card.style.opacity = '1'; }
      }

      function renderCard(item, isApprover) {
        let borderClass = 'marker-gray';
        if(item.company.includes('Blue Bird')) borderClass = 'marker-blue';
        if(item.company.includes('Flash')) borderClass = 'marker-flash';
        if(item.company.includes('–ü—Ä–æ—Ñ—ñ–°—Ç—Ä–æ–π')) borderClass = 'marker-profi';

        const totalSum = parseFloat(item.dailyTotal) + parseFloat(item.transCost);
        const cardId = `card-${item.reqId}`;

        let footerHtml = '';
        if(isApprover) {
          footerHtml = `
            <div class="d-flex gap-2 mt-3 pt-2 border-top">
                <button class="btn btn-outline-danger flex-grow-1" onclick="makeDecision('${item.reqId}', 'reject')">–í—ñ–¥—Ö–∏–ª–∏—Ç–∏</button>
                <button class="btn btn-success flex-grow-1" onclick="makeDecision('${item.reqId}', 'approve')">–ü–æ–≥–æ–¥–∏—Ç–∏</button>
            </div>`;
        } else {
             if(item.status === '–ü–æ–≥–æ–¥–∂–µ–Ω–æ') footerHtml = `<div class="mt-2 text-success small text-end fw-bold"><i class="bi bi-check2-all"></i> –ü–æ–≥–æ–¥–∏–≤: ${item.approver}</div>`;
             if(item.status === '–í—ñ–¥—Ö–∏–ª–µ–Ω–æ') footerHtml = `<div class="mt-2 text-danger small text-end fw-bold"><i class="bi bi-x-circle"></i> –í—ñ–¥—Ö–∏–ª–∏–≤: ${item.approver}</div>`;
        }

        return `
          <div class="card p-3 ${borderClass}" id="${cardId}">
             <div class="d-flex justify-content-between mb-2"><span class="badge bg-light text-dark border">${item.company}</span>${getStatusBadge(item.status)}</div>
             ${isApprover ? `<h6 class="fw-bold mb-0">${item.userName}</h6><small class="text-muted mb-2 d-block">${item.dept}</small>` : ''}
             <div class="fw-bold fs-5 mb-1">${item.purpose}</div>
             <div class="text-muted small mb-2"><i class="bi bi-calendar"></i> ${item.dStart} ‚Äî ${item.dEnd}</div>
             <div class="bg-light rounded p-2 small">
                <div class="d-flex justify-content-between"><span>–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç:</span> <strong>${item.transType} (${item.transCost})</strong></div>
                <div class="d-flex justify-content-between"><span>–î–æ–±–æ–≤—ñ (${item.people} —á–æ–ª):</span> <strong>${item.dailyTotal}</strong></div>
                <div class="d-flex justify-content-between border-top mt-1 pt-1 fw-bold text-dark"><span>–†–ê–ó–û–ú:</span> <span>${totalSum} ‚Ç¥</span></div>
             </div>
             ${footerHtml}
          </div>`;
      }

      function showToast(msg) { document.getElementById('toastMessage').innerText = msg; toastInstance.show(); }
      function getStatusBadge(s) {
        if(s === '–ù–æ–≤–∞') return '<span class="badge-status st-new">–ù–æ–≤–∞</span>';
        if(s === '–ü–æ–≥–æ–¥–∂–µ–Ω–æ') return '<span class="badge-status st-approved">–ü–æ–≥–æ–¥–∂–µ–Ω–æ</span>';
        return '<span class="badge-status st-rejected">–í—ñ–¥—Ö–∏–ª–µ–Ω–æ</span>';
      }
    </script>
  </body>
</html>