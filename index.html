<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>–í—ñ–¥—Ä—è–¥–∂–µ–Ω–Ω—è</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

  <style>
    :root {
      --primary-color: #0d6efd;
      --bg-color: #f0f2f5;
    }

    body {
      padding: 15px 0px 15px 0px;
      background-color: var(--bg-color);
      font-family: -apple-system, system-ui, sans-serif;
      padding-bottom: 90px;
    }

    input,
    select,
    textarea {
      font-size: 16px !important;
    }

    .card {
      border-radius: 16px;
      border: none;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.04);
      margin-bottom: 12px;
      transition: opacity 0.3s;
    }

    .nav-pills {
      background: #fff;
      padding: 5px;
      border-radius: 14px;
      margin-bottom: 20px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }

    .nav-pills .nav-link {
      border-radius: 10px;
      color: #6c757d;
      font-weight: 600;
      font-size: 0.9rem;
      padding: 10px;
    }

    .nav-pills .nav-link.active {
      background-color: var(--primary-color);
      color: #fff;
    }

    .badge-status {
      font-weight: 600;
      padding: 6px 12px;
      border-radius: 8px;
      font-size: 0.75rem;
      text-transform: uppercase;
    }

    .st-new {
      background-color: #e3f2fd;
      color: #0d47a1;
    }

    .st-approved {
      background-color: #d1e7dd;
      color: #0f5132;
    }

    .st-rejected {
      background-color: #f8d7da;
      color: #842029;
    }

    .st-completed {
      background-color: #e2e3e5;
      color: #41464b;
    }

    .st-clarify {
      background-color: #fff3cd;
      color: #664d03;
    }

    .st-clarified {
      background-color: #cff4fc;
      color: #055160;
    }

    .marker-flash {
      border-left: 5px solid #ffc107;
    }

    .marker-blue {
      border-left: 5px solid #0d6efd;
    }

    .marker-profi {
      border-left: 5px solid #6610f2;
    }

    .marker-gray {
      border-left: 5px solid #6c757d;
    }

    .marker-clarify {
      border-left: 5px solid #fd7e14;
    }

    .total-box {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 15px;
      border: 1px dashed #adb5bd;
    }

    .toast-container {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1060;
      width: 97%;
      max-width: 400px;
    }

    .toast {
      background: #333;
      color: #fff;
      border-radius: 12px;
    }

    .expense-form {
      background: #fff;
      border-radius: 12px;
      border: 1px solid #e9ecef;
      padding: 12px;
    }
  </style>
</head>

<body>

  <div class="container" style="max-width: 600px;">

    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
      <div>
        <small class="text-muted text-uppercase fw-bold" style="font-size: 0.65rem;">üë§ –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á</small>
        <div class="fw-bold fs-5 text-dark" id="ui-userName">...</div>
      </div>
      <div>
        <span class="badge bg-light text-dark border"><i class="bi bi-shield-lock"></i> <span
            id="ui-userRole">...</span></span>
        <button class="btn btn-sm btn-white text-primary ms-1" onclick="forceReload()">
          <i class="bi bi-arrow-clockwise fs-5"></i>
        </button>
      </div>
    </div>

    <ul class="nav nav-pills nav-fill" id="pills-tab"></ul>

    <div id="appContent">
      <div class="text-center mt-5 pt-4">
        <div class="spinner-border text-primary"></div>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast-container">
    <div id="liveToast" class="toast align-items-center border-0 shadow" role="alert" aria-live="assertive"
      aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body d-flex align-items-center">
          <i class="bi bi-info-circle-fill me-2 fs-5"></i>
          <span id="toastMessage">...</span>
        </div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>
  </div>

  <!-- Confirm Complete Trip Modal -->
  <div class="modal fade" id="confirmCompleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h6 class="modal-title">–ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è</h6>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          –í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –∑–∞–∫—Ä–∏—Ç–∏ –≤—ñ–¥—Ä—è–¥–∂–µ–Ω–Ω—è? –ü—ñ—Å–ª—è —Ü—ñ—î—ó –¥—ñ—ó –≤–∏ –Ω–µ –∑–º–æ–∂–µ—Ç–µ –¥–æ–¥–∞—Ç–∏ –Ω–æ–≤—ñ –¥–æ–¥–∞—Ç–∫–æ–≤—ñ –≤–∏—Ç—Ä–∞—Ç–∏ –∞–±–æ –∑–º—ñ–Ω–∏—Ç–∏ –ø–æ—Ç–æ—á–Ω—ñ. –ë—É–¥—å –ª–∞—Å–∫–∞, –ø–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—è, —â–æ –≤—Å—ñ —á–µ–∫–∏ —Ç–∞ –≤–∏—Ç—Ä–∞—Ç–∏ –≤–Ω–µ—Å–µ–Ω—ñ.
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">–°–∫–∞—Å—É–≤–∞–Ω–Ω—è</button>
          <button type="button" class="btn btn-success" id="confirmCompleteBtn">–ó–∞–∫—Ä–∏—Ç–∏ –≤—ñ–¥—Ä—è–¥–∂–µ–Ω–Ω—è</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Clarification Modal -->
  <div class="modal fade" id="clarifyModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h6 class="modal-title">–ü–æ—Ç—Ä–µ–±—É—î —É—Ç–æ—á–Ω–µ–Ω–Ω—è</h6>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <textarea class="form-control" id="clarifyText" rows="4"
            placeholder="–û–ø–∏—à—ñ—Ç—å, —â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ —É—Ç–æ—á–Ω–∏—Ç–∏..."></textarea>
          <input type="hidden" id="clarifyReqId">
        </div>
        <div class="modal-footer">
          <button class="btn btn-light" data-bs-dismiss="modal">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
          <button class="btn btn-warning text-dark" id="clarifySubmitBtn" onclick="submitClarifyRequest(this)">–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏</button>
        </div>
      </div>
    </div>
  </div>

    <!-- Edit + Approve Modal -->
    <div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h6 class="modal-title">–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ —Ç–∞ –ø–æ–≥–æ–¥–∏—Ç–∏</h6>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="editReqId">
          <div class="mb-2">
            <label class="small text-muted fw-bold">–ö–æ–º–ø–∞–Ω—ñ—è</label>
            <input type="text" class="form-control" id="editCompany">
          </div>
          <div class="mb-2">
            <label class="small text-muted fw-bold">–í—ñ–¥–¥—ñ–ª</label>
            <input type="text" class="form-control" id="editDept">
          </div>
          <div class="mb-2">
            <label class="small text-muted fw-bold">–ú–µ—Ç–∞</label>
            <input type="text" class="form-control" id="editPurpose">
          </div>
          <div class="row g-2 mb-2">
            <div class="col-6">
              <label class="small text-muted fw-bold">–î–∞—Ç–∞ –ø–æ—á–∞—Ç–∫—É</label>
              <input type="date" class="form-control" id="editStart">
            </div>
            <div class="col-6">
              <label class="small text-muted fw-bold">–î–∞—Ç–∞ –∫—ñ–Ω—Ü—è</label>
              <input type="date" class="form-control" id="editEnd">
            </div>
          </div>
          <div class="row g-2 mb-2">
            <div class="col-6">
              <label class="small text-muted fw-bold">–õ—é–¥–µ–π</label>
              <input type="number" class="form-control" id="editPeople">
            </div>
            <div class="col-6">
              <label class="small text-muted fw-bold">–û–ø–ª–∞—Ç–∞</label>
              <input type="text" class="form-control" id="editPayment">
            </div>
          </div>
          <div class="mb-2">
            <label class="small text-muted fw-bold">–°—Ç–∞–≤–∫–∞ –¥–æ–±–æ–≤–∏—Ö</label>
            <select class="form-select" id="editPerDiemRate"></select>
          </div>
          <div class="mb-2">
            <label class="small text-muted fw-bold">–ü–ª–∞–Ω–æ–≤—ñ –≤–∏—Ç—Ä–∞—Ç–∏</label>
            <div id="editPlanRows"></div>
            <button type="button" class="btn btn-light w-100 mt-2" onclick="addPlanRowTo('editPlanRows')">+ –î–æ–¥–∞—Ç–∏ –≤–∏—Ç—Ä–∞—Ç—É</button>
          </div>
          <div class="mb-2">
            <label class="small text-muted fw-bold">–ö–∞—Ä—Ç–∞ (–∑–∞ –ø–æ—Ç—Ä–µ–±–∏)</label>
            <input type="text" class="form-control" id="editCard" placeholder="–ù–æ–º–µ—Ä –∞–±–æ –Ω–∞–∑–≤–∞ –∫–∞—Ä—Ç–∏">
          </div>
          <div class="mb-2">
            <label class="small text-muted fw-bold">–ö–æ–º–µ–Ω—Ç–∞—Ä –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞ (–æ–±–æ–≤'—è–∑–∫–æ–≤–æ)</label>
            <textarea class="form-control" id="editAdminComment" rows="3" placeholder="–ü—Ä–∏—á–∏–Ω–∞ –∑–º—ñ–Ω / –∫–æ–º–µ–Ω—Ç–∞—Ä"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-light" data-bs-dismiss="modal">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
          <button class="btn btn-success" id="editApproveBtn" onclick="submitEditApprove(this)">–ü–æ–≥–æ–¥–∏—Ç–∏</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Details Modal -->
  <div class="modal fade" id="detailsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h6 class="modal-title">–î–µ—Ç–∞–ª—ñ –∑–∞—è–≤–∫–∏</h6>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="detailsBody">
          <div class="text-center text-muted">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbx0v1qTvhc7VIjnEBfSTTGUT2jW8ITEzF6rJ4_ENgKzGLbC2MGiUKFTgUuOnG9sWgr-/exec";

    const urlParams = new URLSearchParams(window.location.search);
    const USER_ID = urlParams.get('userid');

    let USER_NAME = "";
    let USER_ROLE = "";
    let MY_COMPANIES = [];
    let DEPARTMENTS = [];
    let USER_CARDS = [];
    let DAILY_RATES = [];
    let EXPENSE_OPTIONS = [];
    let CURRENT_VIEW = '';
    let toastInstance;
    let REQUEST_CACHE = {};
    let EXPENSE_CACHE = {};
    let clarifyModalInstance;
    let editModalInstance;
    let detailsModalInstance;
    let DETAILS_EXPENSE_CACHE = {};

    function parseMoney(val) {
      if (val === null || val === undefined) return 0;
      if (val instanceof Date) return 0;
      const s = String(val).trim().replace(/\s+/g, '').replace(',', '.');
      const cleaned = s.replace(/[^0-9.+-]/g, '');
      const n = parseFloat(cleaned);
      return isFinite(n) ? n : 0;
    }

    window.onload = async function () {
      toastInstance = new bootstrap.Toast(document.getElementById('liveToast'), { delay: 3000 });
      clarifyModalInstance = new bootstrap.Modal(document.getElementById('clarifyModal'));
      editModalInstance = new bootstrap.Modal(document.getElementById('editModal'));
      detailsModalInstance = new bootstrap.Modal(document.getElementById('detailsModal'));

      if (!USER_ID) {
        document.getElementById('appContent').innerHTML = '<div class="alert alert-danger text-center">–ù–µ –≤–∫–∞–∑–∞–Ω–æ User ID</div>';
        return;
      }

      // --- –ö–õ–ò–ï–ù–¢–°–ö–û–ï –ö–≠–®–ò–†–û–í–ê–ù–ò–ï ---
      // 1. –ü—Ä–æ–±—É–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç—å—Å—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –∏–∑ –ø–∞–º—è—Ç–∏ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
      const cachedUser = localStorage.getItem('trip_user_v2_' + USER_ID);
      const cachedDepts = localStorage.getItem('trip_depts');
      const cachedRates = localStorage.getItem('trip_rates_v2');
      const cachedOptions = localStorage.getItem('trip_exp_opts');

      if (cachedUser && cachedDepts && cachedRates && cachedOptions) {
        console.log("Loaded from local cache");
        applyUserData(JSON.parse(cachedUser));
        DEPARTMENTS = JSON.parse(cachedDepts);
        DAILY_RATES = JSON.parse(cachedRates);
        EXPENSE_OPTIONS = JSON.parse(cachedOptions);
        initApp();

        // –í —Ñ–æ–Ω–µ –æ–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ (—á—Ç–æ–±—ã –µ—Å–ª–∏ –ø—Ä–∞–≤–∞ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å, —é–∑–µ—Ä —É–∑–Ω–∞–ª –æ–± —ç—Ç–æ–º)
        fetchUserData(true);
      } else {
        // –ï—Å–ª–∏ –∫—ç—à–∞ –Ω–µ—Ç, –≥—Ä—É–∑–∏–º —Å —Å–µ—Ä–≤–µ—Ä–∞
        await fetchUserData(false);
      }
    };

    async function fetchUserData(inBackground) {
      try {
      const [resUser, resDep, resRates, resOpts] = await Promise.all([
        fetch(`${API_URL}?action=getUserInfo&userId=${USER_ID}`),
        fetch(`${API_URL}?action=getDepartments`),
        fetch(`${API_URL}?action=getDailyRates`),
        fetch(`${API_URL}?action=getTripExpenseOptions`)
      ]);

      const userData = await resUser.json();
      const deptData = await resDep.json();
      const rateData = await resRates.json();
      const optData = await resOpts.json();

        if (userData.error) {
          if (!inBackground) document.getElementById('appContent').innerHTML = `<div class="alert alert-danger text-center">${userData.error}</div>`;
          return;
        }

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ø–∞–º—è—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω–∞
        localStorage.setItem('trip_user_v2_' + USER_ID, JSON.stringify(userData));
      localStorage.setItem('trip_depts', JSON.stringify(deptData));
      localStorage.setItem('trip_rates_v2', JSON.stringify(rateData));
      localStorage.setItem('trip_exp_opts', JSON.stringify(optData));

        // –ï—Å–ª–∏ —ç—Ç–æ –Ω–µ —Ñ–æ–Ω–æ–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ, –ø—Ä–∏–º–µ–Ω—è–µ–º –∏ —Ä–µ–Ω–¥–µ—Ä–∏–º
        if (!inBackground) {
          applyUserData(userData);
        DEPARTMENTS = deptData;
        DAILY_RATES = rateData;
        EXPENSE_OPTIONS = optData;
        initApp();
      } else {
        // –ï—Å–ª–∏ —Ñ–æ–Ω–æ–≤–æ–µ - –ø—Ä–æ—Å—Ç–æ –æ–±–Ω–æ–≤–ª—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        applyUserData(userData);
        DEPARTMENTS = deptData;
        DAILY_RATES = rateData;
        EXPENSE_OPTIONS = optData;
      }
      } catch (e) {
        if (!inBackground) showToast("–ü–æ–º–∏–ª–∫–∞ –∑'—î–¥–Ω–∞–Ω–Ω—è: " + e);
      }
    }

    function applyUserData(data) {
      USER_NAME = data.name;
      USER_ROLE = data.role;
      const raw = data.company || "";
      MY_COMPANIES = raw.split(',').map(c => c.trim()).filter(c => c.length > 0);
      const cardsRaw = (data.cards || "").toString();
      USER_CARDS = cardsRaw.split(/\r?\n/).map(c => c.trim()).filter(c => c.length > 0);

      document.getElementById('ui-userName').innerText = USER_NAME;
      document.getElementById('ui-userRole').innerText = USER_ROLE;
    }

    async function forceReload() {
      localStorage.removeItem('trip_user_v2_' + USER_ID); // –ß–∏—Å—Ç–∏–º –∫—ç—à
      localStorage.removeItem('trip_depts');
      localStorage.removeItem('trip_rates_v2');
      localStorage.removeItem('trip_rates');
      localStorage.removeItem('trip_exp_opts');
      try { await sendPost('clearCache', { userId: USER_ID }); } catch (e) {}
      fetchUserData(false);
    }

    function initApp() {
      const nav = document.getElementById('pills-tab');
      // –ï—Å–ª–∏ –º–µ–Ω—é —É–∂–µ –µ—Å—Ç—å, –Ω–µ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –µ–≥–æ (—á—Ç–æ–±—ã –Ω–µ –º–æ—Ä–≥–∞–ª–æ –ø—Ä–∏ —Ñ–æ–Ω–æ–≤–æ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏)
      if (nav.innerHTML.trim() === "") {
        if (USER_ROLE === '–ê–¥–º—ñ–Ω') {
          nav.innerHTML = `
                <li class="nav-item"><a class="nav-link active" onclick="loadApproverPending()">‚ö° –ü–æ–≥–æ–¥–∏—Ç–∏</a></li>
                <li class="nav-item"><a class="nav-link" onclick="loadUserHistory()">üìÇ –ú–æ—ó</a></li>
                <li class="nav-item"><a class="nav-link" onclick="loadUserCreate()">‚ûï –°—Ç–≤–æ—Ä–∏—Ç–∏</a></li>
              `;
          loadApproverPending();
        } else {
          nav.innerHTML = `
                <li class="nav-item"><a class="nav-link active" onclick="loadUserCreate()">‚ûï –°—Ç–≤–æ—Ä–∏—Ç–∏</a></li>
                <li class="nav-item"><a class="nav-link" onclick="loadUserHistory()">üìã –ú–æ—ó –≤—ñ–¥—Ä—è–¥–∂–µ–Ω–Ω—è</a></li>
              `;
          loadUserCreate();
        }
      }
    }

    function refreshTab() {
      if (CURRENT_VIEW === 'create') loadUserCreate();
      else if (CURRENT_VIEW === 'history') loadUserHistory();
      else if (CURRENT_VIEW === 'pending') loadApproverPending();
    }

    function setActiveTab(idx) {
      document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
      const target = document.querySelectorAll('.nav-link')[idx];
      if (target) target.classList.add('active');
    }

    async function sendPost(action, data) {
      const response = await fetch(API_URL, {
        method: 'POST',
        body: JSON.stringify({ action: action, ...data })
      });
      return await response.json();
    }

    // === CREATE FORM ===
    function loadUserCreate() {
      CURRENT_VIEW = 'create';
      const tabIdx = USER_ROLE === '–ê–¥–º—ñ–Ω' ? 2 : 0;
      setActiveTab(tabIdx);

      const deptOpts = DEPARTMENTS.map(d => `<option value="${d}">${d}</option>`).join('');
      let companyOpts = MY_COMPANIES.length > 0
        ? MY_COMPANIES.map(c => `<option value="${c}">${c}</option>`).join('')
        : `<option disabled selected>–ù–µ–º–∞—î –¥–æ—Å—Ç—É–ø—É –¥–æ –∫–æ–º–ø–∞–Ω—ñ–π</option>`;

      const today = new Date().toISOString().split('T')[0];
      const cardOptions = USER_CARDS.length
        ? USER_CARDS.map(c => `<option value="${c}">${c}</option>`).join('')
        : `<option value="" disabled selected>–ù–µ–º–∞—î –∫–∞—Ä—Ç</option>`;
      const rateOptions = DAILY_RATES.length
        ? DAILY_RATES.map(r => `<option value="${r.name}">${r.name}</option>`).join('')
        : `<option value="" disabled selected>–ù–µ–º–∞—î —Å—Ç–∞–≤–æ–∫</option>`;
      const expenseOptions = EXPENSE_OPTIONS.length
        ? EXPENSE_OPTIONS.map(o => `<option value="${o}">${o}</option>`).join('')
        : `<option value="" disabled selected>–ù–µ–º–∞—î –æ–ø—Ü—ñ–π</option>`;

      document.getElementById('appContent').innerHTML = `
          <div class="card p-4 shadow-sm animate__animated animate__fadeIn">
            <form id="tripForm" onsubmit="submitRequest(event)">
              <div class="mb-3"><label class="small text-muted fw-bold">–ö–æ–º–ø–∞–Ω—ñ—è</label><select class="form-select fw-bold" name="company" required>${companyOpts}</select></div>
              <div class="mb-3"><label class="small text-muted fw-bold">–í—ñ–¥–¥—ñ–ª</label><select class="form-select" name="department" required><option value="" disabled selected>–û–±–µ—Ä—ñ—Ç—å –≤—ñ–¥–¥—ñ–ª...</option>${deptOpts}</select></div>
              <div class="mb-3"><label class="small text-muted fw-bold">–ú–µ—Ç–∞ –≤—ñ–¥—Ä—è–¥–∂–µ–Ω–Ω—è</label><input type="text" class="form-control" name="purpose" placeholder="–ù–∞–ø—Ä: –¢—Ä–µ–Ω—ñ–Ω–≥, –í–∏—Å—Ç–∞–≤–∫–∞..." required></div>
              <div class="mb-3"><label class="small text-muted fw-bold">–ö–æ–º–µ–Ω—Ç–∞—Ä</label><input type="text" class="form-control" name="comment" placeholder="–ö–æ–º–µ–Ω—Ç–∞—Ä –¥–æ –∑–∞—è–≤–∫–∏ (–Ω–µ–æ–±–æ–≤'—è–∑–∫–æ–≤–æ)"></div>
              <div class="row g-2 mb-3">
                <div class="col-6"><label class="small text-muted fw-bold">–î–∞—Ç–∞ –ø–æ—á–∞—Ç–∫—É</label><input type="date" class="form-control" name="dateStart" id="dStart" min="${today}" onchange="calcTotal()" required></div>
                <div class="col-6"><label class="small text-muted fw-bold">–î–∞—Ç–∞ –∫—ñ–Ω—Ü—è</label><input type="date" class="form-control" name="dateEnd" id="dEnd" min="${today}" onchange="calcTotal()" required></div>
              </div>
              <div class="mb-3">
                <label class="small text-muted fw-bold">–î–æ–±–æ–≤—ñ</label>
                <select class="form-select" name="perDiemRate" id="perDiemRate" onchange="calcTotal()">${rateOptions}</select>
              </div>
              <div class="mb-3">
                <label class="small text-muted fw-bold">–ü–ª–∞–Ω–æ–≤—ñ –≤–∏—Ç—Ä–∞—Ç–∏</label>
                <div id="planRows"></div>
                <button type="button" class="btn btn-light w-100 mt-2" onclick="addPlanRow()">+ –î–æ–¥–∞—Ç–∏ –≤–∏—Ç—Ä–∞—Ç—É</button>
              </div>
              <div class="row g-2 mb-3">
                 <div class="col-6"><label class="small text-muted fw-bold">–õ—é–¥–µ–π</label><input type="number" class="form-control" name="peopleCount" id="pCount" value="1" min="1" oninput="calcTotal()" required></div>
                 <div class="col-6"><label class="small text-muted fw-bold">–û–ø–ª–∞—Ç–∞</label><select class="form-select" name="paymentMethod" onchange="toggleCardSelect(this.value)"><option value="–ö–∞—Ä—Ç–∞">üí≥ –ù–∞ –∫–∞—Ä—Ç—É</option><option value="–ì–æ—Ç—ñ–≤–∫–∞">üíµ –ì–æ—Ç—ñ–≤–∫–∞</option></select></div>
              </div>
              <div class="mb-3" id="cardSelectBlock">
                <label class="small text-muted fw-bold">–ö–∞—Ä—Ç–∞ –¥–ª—è –∑–∞—Ä–∞—Ö—É–≤–∞–Ω–Ω—è</label>
                <select class="form-select" name="paymentCard" ${USER_CARDS.length ? '' : 'disabled'}>${cardOptions}</select>
              </div>
              <div class="total-box mb-3">
                <div class="d-flex justify-content-between mb-1"><small class="text-muted">–î–æ–±–æ–≤—ñ:</small><small class="fw-bold" id="calcDaily">0 ‚Ç¥</small></div>
                <div class="d-flex justify-content-between mb-1"><small class="text-muted">–ü–ª–∞–Ω–æ–≤—ñ –≤–∏—Ç—Ä–∞—Ç–∏:</small><small class="fw-bold" id="calcPlan">0 ‚Ç¥</small></div>
                <div class="d-flex justify-content-between align-items-center border-top pt-2 mt-2"><span class="fw-bold text-dark">–í–°–¨–û–ì–û:</span><span class="fs-5 fw-bold text-primary" id="calcTotal">0 ‚Ç¥</span></div>
              </div>
              <button type="submit" id="btnSubmit" class="btn btn-primary w-100 py-3 rounded-pill fw-bold shadow">–°—Ç–≤–æ—Ä–∏—Ç–∏ –∑–∞—è–≤–∫—É</button>
            </form>
          </div>`;
      const rateSel = document.getElementById('perDiemRate');
      if (rateSel && !rateSel.value && DAILY_RATES.length) {
        rateSel.value = DAILY_RATES[0].name;
      }
      addPlanRow();
      calcTotal();
    }

    function calcTotal() {
      const dStartEl = document.getElementById('dStart');
      const dEndEl = document.getElementById('dEnd');
      const peopleEl = document.getElementById('pCount');
      const rateEl = document.getElementById('perDiemRate');
      const planEl = document.getElementById('calcPlan');
      const dailyEl = document.getElementById('calcDaily');
      const totalEl = document.getElementById('calcTotal');
      if (!dStartEl || !dEndEl || !peopleEl || !rateEl || !planEl || !dailyEl || !totalEl) return;
      const dS = dStartEl.value;
      const dE = dEndEl.value;
      const cost = 0;
      const people = parseInt(peopleEl.value) || 1;
      const rateName = rateEl.value;
      const planTotal = calcPlanTotal();
      planEl.innerText = planTotal.toLocaleString() + ' ‚Ç¥';

      if (dS && dE) {
        const start = new Date(dS);
        const end = new Date(dE);
        if (start > end) {
          dailyEl.innerText = '-';
          totalEl.innerText = '-';
          planEl.innerText = '-';
          return;
        }
        const diffDays = Math.ceil(Math.abs(end - start) / (86400000)) + 1;
        const rates = getPerDiemRates(rateName);
        const dailySum = calcDailyTotalByDays(diffDays, people, rates.rateShort, rates.rateLong);
        dailyEl.innerText = dailySum.toLocaleString() + ' ‚Ç¥';
        totalEl.innerText = (dailySum + cost + planTotal).toLocaleString() + ' ‚Ç¥';
      } else {
        dailyEl.innerText = '0 ‚Ç¥';
        totalEl.innerText = (cost + planTotal).toLocaleString() + ' ‚Ç¥';
      }
    }

    function getPerDiemRates(name) {
      const item = DAILY_RATES.find(r => String(r.name) === String(name));
      if (!item) return { rateShort: 0, rateLong: 0 };
      return { rateShort: Number(item.rateShort) || 0, rateLong: Number(item.rateLong) || 0 };
    }

    function calcDailyTotalByDays(days, people, rateShort, rateLong) {
      const d = Number(days) || 0;
      const p = parseInt(people) || 1;
      const firstDays = Math.min(d, 3);
      const restDays = Math.max(d - 3, 0);
      return (firstDays * (Number(rateShort) || 0) + restDays * (Number(rateLong) || 0)) * p;
    }

    function getTripDays(dStart, dEnd) {
      if (!dStart || !dEnd) return 0;
      const start = new Date(dStart);
      const end = new Date(dEnd);
      return Math.ceil(Math.abs(end - start) / (86400000)) + 1;
    }

    function calcPlanTotal() {
      const rows = document.querySelectorAll('#planRows .plan-row');
      let sum = 0;
      rows.forEach(r => {
        const amt = parseFloat(r.querySelector('[data-plan-amount]').value) || 0;
        sum += amt;
      });
      return sum;
    }

    function toggleCardSelect(method) {
      const block = document.getElementById('cardSelectBlock');
      if (!block) return;
      if (method === '–ö–∞—Ä—Ç–∞') {
        block.classList.remove('d-none');
      } else {
        const sel = block.querySelector('select');
        if (sel) sel.value = "";
        block.classList.add('d-none');
      }
    }

    function addPlanRow() {
      addPlanRowTo('planRows');
    }

    function addPlanRowTo(containerId, preset) {
      const container = document.getElementById(containerId);
      if (!container) return;
      const optionsHtml = EXPENSE_OPTIONS.map(o => `<option value="${o}">${o}</option>`).join('');
      const row = document.createElement('div');
      row.className = 'plan-row border rounded p-2 mb-2';
      row.innerHTML = `
        <div class="d-flex gap-2 align-items-center mb-2">
          <select class="form-select" data-plan-name onchange="togglePlanCustom(this)">
            ${optionsHtml}
            <option value="–Ü–Ω—à–µ">–Ü–Ω—à–µ</option>
          </select>
          <button type="button" class="btn btn-sm btn-outline-danger" onclick="removePlanRow(this)">‚úï</button>
        </div>
        <input type="text" class="form-control mb-2 d-none" data-plan-custom placeholder="–í–∫–∞–∂—ñ—Ç—å —Å–≤—ñ–π –≤–∞—Ä—ñ–∞–Ω—Ç">
        <input type="number" class="form-control" data-plan-amount placeholder="–°—É–º–∞" oninput="calcTotal()">
      `;
      container.appendChild(row);
      if (preset) {
        const sel = row.querySelector('[data-plan-name]');
        const custom = row.querySelector('[data-plan-custom]');
        const amt = row.querySelector('[data-plan-amount]');
        if (EXPENSE_OPTIONS.includes(preset.name)) {
          sel.value = preset.name;
        } else {
          sel.value = '–Ü–Ω—à–µ';
          custom.classList.remove('d-none');
          custom.value = preset.name;
        }
        amt.value = preset.amount || '';
      }
      calcTotal();
    }

    function removePlanRow(btn) {
      const row = btn.closest('.plan-row');
      if (row) row.remove();
      calcTotal();
    }

    function togglePlanCustom(selectEl) {
      const row = selectEl.closest('.plan-row');
      if (!row) return;
      const custom = row.querySelector('[data-plan-custom]');
      if (selectEl.value === '–Ü–Ω—à–µ') {
        custom.classList.remove('d-none');
      } else {
        custom.value = '';
        custom.classList.add('d-none');
      }
    }

    async function submitRequest(e) {
      e.preventDefault();
      const btn = document.getElementById('btnSubmit');
      const form = document.getElementById('tripForm');

      if (MY_COMPANIES.length === 0) { showToast("–ù–µ–º–∞—î –¥–æ—Å—Ç—É–ø—É –¥–æ –∫–æ–º–ø–∞–Ω—ñ–π"); return; }

      btn.disabled = true;
      btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';

      const perDiemEl = document.getElementById('perDiemRate');
      const days = getTripDays(form.dateStart.value, form.dateEnd.value);
      const perDiemName = perDiemEl ? perDiemEl.value : "";
      const rates = getPerDiemRates(perDiemName);
      const perDiemRate = rates.rateLong;
      const data = {
        userId: USER_ID, userName: USER_NAME,
        company: form.company.value, department: form.department.value, purpose: form.purpose.value,
        comment: form.comment.value,
        dateStart: form.dateStart.value, dateEnd: form.dateEnd.value,
        transportType: "", transportCost: 0,
        peopleCount: form.peopleCount.value, paymentMethod: form.paymentMethod.value,
        paymentCard: form.paymentCard ? form.paymentCard.value : "",
        perDiemRate: perDiemRate,
        perDiemName: perDiemName,
        planItems: collectPlanItems()
      };

      if (data.paymentMethod === '–ö–∞—Ä—Ç–∞' && !data.paymentCard) {
        showToast("–û–±–µ—Ä—ñ—Ç—å –∫–∞—Ä—Ç—É –¥–ª—è –∑–∞—Ä–∞—Ö—É–≤–∞–Ω–Ω—è");
        btn.disabled = false;
        btn.innerHTML = '–°—Ç–≤–æ—Ä–∏—Ç–∏ –∑–∞—è–≤–∫—É';
        return;
      }
      if (!data.perDiemName) {
        showToast("–û–±–µ—Ä—ñ—Ç—å —Å—Ç–∞–≤–∫—É –¥–æ–±–æ–≤–∏—Ö");
        btn.disabled = false;
        btn.innerHTML = '–°—Ç–≤–æ—Ä–∏—Ç–∏ –∑–∞—è–≤–∫—É';
        return;
      }

      try {
        const res = await sendPost('createRequest', { data });
        if (res.status === 'success') { showToast(res.message); loadUserHistory(); }
        else { showToast("–ü–æ–º–∏–ª–∫–∞: " + res.message); btn.disabled = false; btn.innerHTML = '–°—Ç–≤–æ—Ä–∏—Ç–∏ –∑–∞—è–≤–∫—É'; }
      } catch (err) { showToast("–ü–æ–º–∏–ª–∫–∞: " + err); btn.disabled = false; btn.innerHTML = '–°—Ç–≤–æ—Ä–∏—Ç–∏ –∑–∞—è–≤–∫—É'; }
    }

    async function loadUserHistory() {
      CURRENT_VIEW = 'history';
      const tabIdx = USER_ROLE === '–ê–¥–º—ñ–Ω' ? 1 : 1;
      setActiveTab(tabIdx);
      document.getElementById('appContent').innerHTML = '<div class="text-center mt-5"><div class="spinner-border text-secondary"></div></div>';

      const res = await fetch(`${API_URL}?action=getUserRequests&userId=${USER_ID}`);
      const data = await res.json();

      if (data.length === 0) { document.getElementById('appContent').innerHTML = '<div class="text-center text-muted mt-5">–Ü—Å—Ç–æ—Ä—ñ—è –ø–æ—Ä–æ–∂–Ω—è</div>'; return; }
      REQUEST_CACHE = {};
      DETAILS_EXPENSE_CACHE = {};
      const sorted = data.slice().sort((a, b) => {
        const aActive = isActiveStatus(a.status) ? 0 : 1;
        const bActive = isActiveStatus(b.status) ? 0 : 1;
        if (aActive !== bActive) return aActive - bActive;
        return compareDateAsc(a.dStart, b.dStart);
      });
      sorted.forEach(item => { REQUEST_CACHE[item.reqId] = item; });

      const COMPLETED_STATUSES = { '–ó–∞–≤–µ—Ä—à–µ–Ω–æ': true, '–û–ø–ª–∞—á–µ–Ω–æ': true, '–í—ñ–¥—Ö–∏–ª–µ–Ω–æ': true };
      const active = sorted.filter(i => !COMPLETED_STATUSES[i.status]);
      const completed = sorted.filter(i => COMPLETED_STATUSES[i.status]);

      let html = '';
      html += active.map(item => renderCard(item, false)).join('');
      if (completed.length > 0) {
        const collapsed = localStorage.getItem('trip_completed_collapsed') !== '0';
        html += `
          <div class="card p-3 mt-2">
            <div class="d-flex justify-content-between align-items-center">
              <strong>–ê—Ä—Ö—ñ–≤ (${completed.length})</strong>
              <button class="btn btn-sm btn-outline-secondary" onclick="toggleCompleted()">–ü–æ–∫–∞–∑–∞—Ç–∏/–°—Ö–æ–≤–∞—Ç–∏</button>
            </div>
            <div id="completedBlock" class="${collapsed ? 'd-none' : ''} mt-2">
              ${completed.map(item => renderCard(item, false)).join('')}
            </div>
          </div>
        `;
      }
      document.getElementById('appContent').innerHTML = html;
    }

      async function loadApproverPending() {
        CURRENT_VIEW = 'pending';
        setActiveTab(0);
        document.getElementById('appContent').innerHTML = '<div class="text-center mt-5"><div class="spinner-border text-primary"></div></div>';

      const [resReq, resExp] = await Promise.all([
        fetch(`${API_URL}?action=getAdminRequests&userId=${USER_ID}`),
        fetch(`${API_URL}?action=getPendingExpensesGrouped&userId=${USER_ID}`)
      ]);
      const data = await resReq.json();
      const expensesGrouped = await resExp.json();

      REQUEST_CACHE = {};
      EXPENSE_CACHE = {};
      DETAILS_EXPENSE_CACHE = {};
      const sortedReq = data.slice().sort((a, b) => {
        const aActive = isActionableStatus(a.status) ? 0 : 1;
        const bActive = isActionableStatus(b.status) ? 0 : 1;
        if (aActive !== bActive) return aActive - bActive;
        return String(b.created).localeCompare(String(a.created));
      });
      sortedReq.forEach(item => { REQUEST_CACHE[item.reqId] = item; });

      let html = '';
      if (expensesGrouped.length > 0) {
        html += `<div class="fw-bold text-muted mb-2">–í–∏—Ç—Ä–∞—Ç–∏ –Ω–∞ –∑–∞—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è</div>`;
        html += expensesGrouped.map(item => renderExpenseGroupCard(item)).join('');
      }
      if (sortedReq.length > 0) {
        const APPROVAL = { '–ù–æ–≤–∞': true, '–£—Ç–æ—á–Ω–µ–Ω–æ': true, '–ü–æ—Ç—Ä–µ–±—É—î —É—Ç–æ—á–Ω–µ–Ω–Ω—è': true };
        const ACCOUNTING = { '–ü–æ–≥–æ–¥–∂–µ–Ω–æ': true };
        const ARCHIVE = { '–û–ø–ª–∞—á–µ–Ω–æ': true, '–í—ñ–¥—Ö–∏–ª–µ–Ω–æ': true, '–ó–∞–≤–µ—Ä—à–µ–Ω–æ': true };

        const approvalReq = sortedReq.filter(i => APPROVAL[i.status]);
        const accountingReq = sortedReq.filter(i => ACCOUNTING[i.status]);
        const archiveReq = sortedReq.filter(i => ARCHIVE[i.status]);

        const collapsedApproval = localStorage.getItem('trip_admin_approval_collapsed') !== '0';
        const collapsedAccounting = localStorage.getItem('trip_admin_accounting_collapsed') !== '0';
        const collapsedArchive = localStorage.getItem('trip_admin_archive_collapsed') !== '0';

        html += `<div class="fw-bold text-muted ${expensesGrouped.length ? 'mt-4' : ''} mb-2">–ó–∞—è–≤–∫–∏</div>`;

        // 1) Approval
        html += `
          <div class="card p-3 mt-2">
            <div class="d-flex justify-content-between align-items-center">
              <strong>üìÇ –¢—Ä–µ–±—É—é—Ç—å –∑–∞—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è (${approvalReq.length})</strong>
              <button class="btn btn-sm btn-outline-secondary" onclick="toggleAdminSection('approval')">–ü–æ–∫–∞–∑–∞—Ç–∏/–°—Ö–æ–≤–∞—Ç–∏</button>
            </div>
            <div id="adminApprovalBlock" class="${collapsedApproval ? 'd-none' : ''} mt-2">
              ${approvalReq.map(item => renderCard(item, true)).join('')}
            </div>
          </div>
        `;

        // 2) Accounting
        html += `
          <div class="card p-3 mt-2">
            <div class="d-flex justify-content-between align-items-center">
              <strong>üìÇ –ù–∞ –æ–ø–ª–∞—Ç—É (${accountingReq.length})</strong>
              <button class="btn btn-sm btn-outline-secondary" onclick="toggleAdminSection('accounting')">–ü–æ–∫–∞–∑–∞—Ç–∏/–°—Ö–æ–≤–∞—Ç–∏</button>
            </div>
            <div id="adminAccountingBlock" class="${collapsedAccounting ? 'd-none' : ''} mt-2">
              ${accountingReq.map(item => renderCard(item, true)).join('')}
            </div>
          </div>
        `;

        // 3) Archive
        html += `
          <div class="card p-3 mt-2">
            <div class="d-flex justify-content-between align-items-center">
              <strong>üìÇ –ê—Ä—Ö—ñ–≤ (${archiveReq.length})</strong>
              <button class="btn btn-sm btn-outline-secondary" onclick="toggleAdminSection('archive')">–ü–æ–∫–∞–∑–∞—Ç–∏/–°—Ö–æ–≤–∞—Ç–∏</button>
            </div>
            <div id="adminArchiveBlock" class="${collapsedArchive ? 'd-none' : ''} mt-2">
              ${archiveReq.map(item => renderCard(item, true)).join('')}
            </div>
          </div>
        `;
      }
      if (!html) html = '<div class="text-center text-muted mt-5">–ù–µ–º–∞—î –∑–∞—è–≤–æ–∫</div>';
      document.getElementById('appContent').innerHTML = html;
      }

    async function markPaid(reqId, btn) {
      if (!confirm("–ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ –æ–ø–ª–∞—Ç—É?")) return;
      const card = document.getElementById(`card-${reqId}`);
      if (card) card.style.opacity = '0.5';
      setBtnLoading(btn, true);
      try {
        const res = await sendPost('markPaid', { rowId: reqId, adminId: USER_ID, adminName: USER_NAME });
        if (res.status === 'success') { showToast(res.message); loadApproverPending(); }
        else { showToast(res.message); if (card) card.style.opacity = '1'; }
      } catch (err) { showToast("–ü–æ–º–∏–ª–∫–∞: " + err); if (card) card.style.opacity = '1'; }
      setBtnLoading(btn, false);
    }

    async function makeDecision(reqId, decision, btn) {
      if (!confirm(decision === 'approve' ? "–ü–æ–≥–æ–¥–∏—Ç–∏?" : "–í—ñ–¥—Ö–∏–ª–∏—Ç–∏?")) return;
      const card = document.getElementById(`card-${reqId}`);
      if (card) card.style.opacity = '0.5';
      setBtnLoading(btn, true);

      try {
        const res = await sendPost('approveRequest', { rowId: reqId, approver: USER_NAME, approverId: USER_ID, decision: decision });
        if (res.status === 'success') { showToast(res.message); loadApproverPending(); }
        else { showToast(res.message); if (card) card.style.opacity = '1'; }
      } catch (err) { showToast("–ü–æ–º–∏–ª–∫–∞: " + err); if (card) card.style.opacity = '1'; }
      setBtnLoading(btn, false);
    }

    function openClarifyModal(reqId) {
      document.getElementById('clarifyReqId').value = reqId;
      document.getElementById('clarifyText').value = '';
      clarifyModalInstance.show();
    }

    async function submitClarifyRequest(btn) {
      const reqId = document.getElementById('clarifyReqId').value;
      const text = document.getElementById('clarifyText').value.trim();
      if (!text) { showToast("–í–∫–∞–∂—ñ—Ç—å —É—Ç–æ—á–Ω–µ–Ω–Ω—è"); return; }
      setBtnLoading(btn, true);
      try {
        const res = await sendPost('requestClarification', { rowId: reqId, adminId: USER_ID, adminName: USER_NAME, question: text });
        if (res.status === 'success') { showToast(res.message); clarifyModalInstance.hide(); loadApproverPending(); }
        else showToast(res.message);
      } catch (err) { showToast("–ü–æ–º–∏–ª–∫–∞: " + err); }
      setBtnLoading(btn, false);
    }

    function openEditModal(reqId, ev) {
      if (ev && ev.stopPropagation) ev.stopPropagation();
      const item = REQUEST_CACHE[reqId];
      if (!item) { showToast("–î–∞–Ω—ñ –∑–∞—è–≤–∫–∏ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ"); return; }
      try {
        setElValue('editReqId', reqId);
        setElValue('editCompany', item.company || '');
        setElValue('editDept', item.dept || '');
        setElValue('editPurpose', item.purpose || '');
        setElValue('editStart', item.dStart || '');
        setElValue('editEnd', item.dEnd || '');
        setElValue('editPeople', item.people || 1);
        setElValue('editPayment', item.payment || '');
        setElValue('editCard', item.paymentCard || '');
        setElValue('editAdminComment', '');
        const rateSel = document.getElementById('editPerDiemRate');
        if (rateSel) {
          rateSel.innerHTML = DAILY_RATES.map(r => `<option value="${r.name}">${r.name}</option>`).join('');
          rateSel.value = item.perDiemName || '';
        }
        const planContainer = document.getElementById('editPlanRows');
        if (planContainer) planContainer.innerHTML = '';
        const planItems = parsePlanItems(item.planItemsJson);
        if (planItems.length === 0) addPlanRowTo('editPlanRows');
        else planItems.forEach(i => addPlanRowTo('editPlanRows', i));
        editModalInstance.show();
      } catch (e) {
        console.error(e);
        showToast("–ü–æ–º–∏–ª–∫–∞: " + e);
      }
    }

    async function submitEditApprove(btn) {
      const reqIdEl = document.getElementById('editReqId');
      const adminCommentEl = document.getElementById('editAdminComment');
      const companyEl = document.getElementById('editCompany');
      const deptEl = document.getElementById('editDept');
      const purposeEl = document.getElementById('editPurpose');
      const startEl = document.getElementById('editStart');
      const endEl = document.getElementById('editEnd');
      const peopleEl = document.getElementById('editPeople');
      const paymentEl = document.getElementById('editPayment');
      const cardEl = document.getElementById('editCard');
      const rateEl = document.getElementById('editPerDiemRate');
      const reqId = reqIdEl ? reqIdEl.value : '';
      const adminCommentVal = adminCommentEl ? adminCommentEl.value.trim() : '';
      if (!companyEl || !deptEl || !purposeEl || !startEl || !endEl || !peopleEl || !paymentEl || !cardEl || !rateEl) {
        showToast("–ü–æ–º–∏–ª–∫–∞: —Ñ–æ—Ä–º–∞ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –Ω–µ –≥–æ—Ç–æ–≤–∞");
        return;
      }
      if (!adminCommentVal) { showToast("–ü–æ—Ç—Ä—ñ–±–µ–Ω –∫–æ–º–µ–Ω—Ç–∞—Ä –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞"); return; }
      setBtnLoading(btn, true);
      const days = getTripDays(startEl.value, endEl.value);
      const perDiemName = rateEl ? rateEl.value : "";
      const rates = getPerDiemRates(perDiemName);
      const perDiemRate = rates.rateLong;
      const data = {
        company: companyEl.value,
        department: deptEl.value,
        purpose: purposeEl.value,
        dateStart: startEl.value,
        dateEnd: endEl.value,
        peopleCount: peopleEl.value,
        paymentMethod: paymentEl.value,
        paymentCard: cardEl.value,
        adminComment: adminCommentVal,
        perDiemRate: perDiemRate,
        perDiemName: perDiemName,
        planItemsJson: JSON.stringify(collectPlanItemsFrom('editPlanRows')),
        planItemsTotal: collectPlanItemsFrom('editPlanRows').reduce((s, i) => s + (Number(i.amount) || 0), 0)
      };
      try {
        const res = await sendPost('updateAndApproveRequest', { rowId: reqId, approver: USER_NAME, approverId: USER_ID, data });
        if (res.status === 'success') { showToast(res.message); editModalInstance.hide(); loadApproverPending(); }
        else showToast(res.message);
      } catch (err) { showToast("–ü–æ–º–∏–ª–∫–∞: " + err); }
      setBtnLoading(btn, false);
    }

    async function submitClarificationAnswer(reqId, btn) {
      const input = document.getElementById(`clarify-answer-${reqId}`);
      if (!input) return;
      const text = input.value.trim();
      if (!text) { showToast("–í–∫–∞–∂—ñ—Ç—å –≤—ñ–¥–ø–æ–≤—ñ–¥—å"); return; }
      setBtnLoading(btn, true);
      try {
        const res = await sendPost('submitClarificationAnswer', { rowId: reqId, userId: USER_ID, answer: text });
        if (res.status === 'success') { showToast(res.message); loadUserHistory(); }
        else showToast(res.message);
      } catch (err) { showToast("–ü–æ–º–∏–ª–∫–∞: " + err); }
      setBtnLoading(btn, false);
    }

    function toggleExpensesForm(reqId) {
      const block = document.getElementById(`exp-block-${reqId}`);
      if (block) {
        block.classList.toggle('d-none');
        const container = document.getElementById(`exp-rows-${reqId}`);
        if (container && container.children.length === 0) addExpenseRow(reqId);
      }
    }

    function addExpenseRow(reqId) {
      const container = document.getElementById(`exp-rows-${reqId}`);
      if (!container) return;
      const idx = container.children.length + 1;
      const row = document.createElement('div');
      row.className = 'expense-form mb-2';
      row.innerHTML = `
          <div class="d-flex justify-content-between align-items-center mb-2">
            <strong class="small text-muted">–í–∏—Ç—Ä–∞—Ç–∞ ${idx}</strong>
            <button class="btn btn-sm btn-outline-danger" onclick="removeExpenseRow(this); event.stopPropagation();">‚úï</button>
          </div>
          <div class="mb-2"><input type="text" class="form-control" placeholder="–ù–∞–∑–≤–∞ –≤–∏—Ç—Ä–∞—Ç–∏" data-exp-name required></div>
          <div class="mb-2"><input type="number" class="form-control" placeholder="–°—É–º–∞" data-exp-amount required></div>
          <div class="mb-2"><input type="text" class="form-control" placeholder="–û–ø–∏—Å (–Ω–µ–æ–±–æ–≤'—è–∑–∫–æ–≤–æ)" data-exp-desc></div>
          <div class="mb-2"><input type="text" class="form-control" placeholder="–ü–æ—Å–∏–ª–∞–Ω–Ω—è (–Ω–µ–æ–±–æ–≤'—è–∑–∫–æ–≤–æ)" data-exp-link></div>
        <!-- TODO: —Ñ–∞–π–ª–∏ —Ç–∏–º—á–∞—Å–æ–≤–æ –ø—Ä–∏—Ö–æ–≤–∞–Ω—ñ –¥–æ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è Drive -->
        <!-- <div class="mb-1"><input type="file" class="form-control" data-exp-files multiple></div> -->
        `;
      container.appendChild(row);
    }

    function removeExpenseRow(btn) {
      const row = btn.closest('.expense-form');
      if (row) row.remove();
    }

    async function submitExpenses(reqId, btn) {
      const container = document.getElementById(`exp-rows-${reqId}`);
      if (!container) return;
      const rows = Array.from(container.children);
      const expenses = [];

      for (const row of rows) {
        const name = row.querySelector('[data-exp-name]').value.trim();
        const amount = row.querySelector('[data-exp-amount]').value.trim();
        const description = row.querySelector('[data-exp-desc]').value.trim();
        const link = row.querySelector('[data-exp-link]').value.trim();
        const filesInput = row.querySelector('[data-exp-files]');
        if (!name || !amount) { showToast("–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –Ω–∞–∑–≤—É —ñ —Å—É–º—É"); return; }

        const files = [];
        const fileList = filesInput ? Array.from(filesInput.files || []) : [];
        for (const f of fileList) {
          if (f.size > 5 * 1024 * 1024) { showToast("–§–∞–π–ª –∑–∞–Ω–∞–¥—Ç–æ –≤–µ–ª–∏–∫–∏–π (–º–∞–∫—Å 5MB)"); return; }
          const data = await readFileAsBase64(f);
          files.push({ name: f.name, mime: f.type, data: data });
        }

        expenses.push({ name, amount, description, link, files });
      }

      setBtnLoading(btn, true);
      try {
        const res = await sendPost('submitExpenses', { rowId: reqId, userId: USER_ID, userName: USER_NAME, expenses });
        if (res.status === 'success') {
          if (res.debug && res.debug.length) {
            showToast(res.message);
            showDebugPanel(res.debug);
            console.log("Drive debug:", res.debug);
          } else {
            showToast(res.message);
          }
          loadUserHistory();
        }
        else showToast(res.message);
      } catch (err) { showToast("–ü–æ–º–∏–ª–∫–∞: " + err); }
      setBtnLoading(btn, false);
    }

    function readFileAsBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => {
          const base64 = (reader.result || '').toString().split(',')[1] || '';
          resolve(base64);
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    function setBtnLoading(btn, loading) {
      if (!btn) return;
      if (loading) {
        if (!btn.dataset.prev) btn.dataset.prev = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
      } else {
        btn.disabled = false;
        if (btn.dataset.prev) {
          btn.innerHTML = btn.dataset.prev;
          delete btn.dataset.prev;
        }
      }
    }

    function setElValue(id, value) {
      const el = document.getElementById(id);
      if (!el) throw new Error(`Element not found: ${id}`);
      el.value = value;
    }

    function collectPlanItems() {
      return collectPlanItemsFrom('planRows');
    }

    function collectPlanItemsFrom(containerId) {
      const rows = document.querySelectorAll(`#${containerId} .plan-row`);
      const items = [];
      rows.forEach(r => {
        const nameSelect = r.querySelector('[data-plan-name]').value;
        const custom = r.querySelector('[data-plan-custom]').value.trim();
        const amount = parseFloat(r.querySelector('[data-plan-amount]').value) || 0;
        if (!amount) return;
        const name = nameSelect === '–Ü–Ω—à–µ' ? custom : nameSelect;
        if (!name) return;
        items.push({ name, amount });
      });
      return items;
    }

    function showDebugPanel(lines) {
      const containerId = 'debugPanel';
      let panel = document.getElementById(containerId);
      if (!panel) {
        panel = document.createElement('div');
        panel.id = containerId;
        panel.className = 'card p-3 mt-2';
        panel.innerHTML = `
          <div class="d-flex justify-content-between align-items-center mb-2">
            <strong>Debug (Drive)</strong>
            <button class="btn btn-sm btn-outline-secondary" onclick="this.closest('#${containerId}').remove()">–ó–∞–∫—Ä–∏—Ç–∏</button>
          </div>
          <pre class="small text-muted mb-0" style="white-space: pre-wrap;"></pre>
        `;
        const app = document.getElementById('appContent');
        if (app) app.prepend(panel);
      }
      const pre = panel.querySelector('pre');
      if (pre) pre.textContent = lines.join('\n');
    }

    async function decideExpenseBatch(reqId, expenseIds, decision, expenseItems, btn) {
      if (!expenseIds || expenseIds.length === 0) return;
      if (!confirm(decision === 'approve' ? "–ü–æ–≥–æ–¥–∏—Ç–∏ –≤–∏—Ç—Ä–∞—Ç–∏?" : "–í—ñ–¥—Ö–∏–ª–∏—Ç–∏ –≤–∏—Ç—Ä–∞—Ç–∏?")) return;
      const card = document.getElementById(`exp-group-${reqId}`);
      if (card) card.style.opacity = '0.5';
      setBtnLoading(btn, true);
      try {
        const res = await sendPost('decideExpensesBatch', { expenseIds, expenseItems, approver: USER_NAME, decision });
        if (res.status === 'success') { showToast(res.message); loadApproverPending(); }
        else { showToast(res.message); if (card) card.style.opacity = '1'; }
      } catch (err) { showToast("–ü–æ–º–∏–ª–∫–∞: " + err); if (card) card.style.opacity = '1'; }
      setBtnLoading(btn, false);
    }

    function renderCard(item, isApprover) {
      let borderClass = 'marker-gray';
      if (item.company.includes('Blue Bird')) borderClass = 'marker-blue';
      if (item.company.includes('Flash')) borderClass = 'marker-flash';
      if (item.company.includes('–ü—Ä–æ—Ñ—ñ–°—Ç—Ä–æ–π')) borderClass = 'marker-profi';
      if (item.status === '–ü–æ—Ç—Ä–µ–±—É—î —É—Ç–æ—á–Ω–µ–Ω–Ω—è') borderClass = 'marker-clarify';

      const approvedExtra = parseFloat(item.additionalItemsTotal || 0) || 0;
      const planTotal = parseFloat(item.planItemsTotal || 0) || 0;
      const totalSum = parseFloat(item.dailyTotal) + planTotal + approvedExtra;
      const cardId = `card-${item.reqId}`;

      let footerHtml = '';
      const isActionable = isApprover && (item.status === '–ù–æ–≤–∞' || item.status === '–£—Ç–æ—á–Ω–µ–Ω–æ' || item.status === '–ü–æ—Ç—Ä–µ–±—É—î —É—Ç–æ—á–Ω–µ–Ω–Ω—è');
      if (isActionable) {
        footerHtml = `
            <div class="d-flex gap-2 mt-3 pt-2 border-top no-modal">
                <button class="btn btn-outline-danger flex-grow-1" onclick="makeDecision('${item.reqId}', 'reject', this)">–í—ñ–¥—Ö–∏–ª–∏—Ç–∏</button>
                <button class="btn btn-success flex-grow-1" onclick="makeDecision('${item.reqId}', 'approve', this)">–ü–æ–≥–æ–¥–∏—Ç–∏</button>
            </div>`;
        footerHtml += `
            <div class="d-flex gap-2 mt-2 no-modal">
                <button class="btn btn-outline-warning flex-grow-1" onclick="openClarifyModal('${item.reqId}')">–ü–æ—Ç—Ä–µ–±—É—î —É—Ç–æ—á–Ω–µ–Ω–Ω—è</button>
                <button class="btn btn-outline-primary flex-grow-1" onclick="openEditModal('${item.reqId}', event)">–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ —Ç–∞ –ø–æ–≥–æ–¥–∏—Ç–∏</button>
            </div>`;
      } else {
        if (isApprover && item.status === '–ü–æ–≥–æ–¥–∂–µ–Ω–æ') {
          footerHtml = `
            <div class="d-flex gap-2 mt-3 pt-2 border-top no-modal">
              <button class="btn btn-success flex-grow-1" onclick="markPaid('${item.reqId}', this)">üí∏ –ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ –æ–ø–ª–∞—Ç—É</button>
            </div>
            <div class="mt-2 text-success small text-end fw-bold"><i class="bi bi-check2-all"></i> –ü–æ–≥–æ–¥–∏–≤: ${item.approver}</div>
          `;
        } else {
          if (item.status === '–ü–æ–≥–æ–¥–∂–µ–Ω–æ') footerHtml = `<div class="mt-2 text-success small text-end fw-bold"><i class="bi bi-check2-all"></i> –ü–æ–≥–æ–¥–∏–≤: ${item.approver}</div>`;
        }
        if (item.status === '–í—ñ–¥—Ö–∏–ª–µ–Ω–æ') footerHtml = `<div class="mt-2 text-danger small text-end fw-bold"><i class="bi bi-x-circle"></i> –í—ñ–¥—Ö–∏–ª–∏–≤: ${item.approver}</div>`;
        if (item.status === '–û–ø–ª–∞—á–µ–Ω–æ') footerHtml = `<div class="mt-2 text-success small text-end fw-bold"><i class="bi bi-cash-coin"></i> –û–ø–ª–∞—á–µ–Ω–æ</div>`;
      }

      let clarifyHtml = '';
      if (item.clarifyQuestion) {
        clarifyHtml += `<div class="mt-2 small text-warning"><i class="bi bi-question-circle"></i> –£—Ç–æ—á–Ω–µ–Ω–Ω—è: ${item.clarifyQuestion}</div>`;
      }
      if (item.clarifyAnswer) {
        clarifyHtml += `<div class="mt-1 small text-info"><i class="bi bi-chat-left-text"></i> –í—ñ–¥–ø–æ–≤—ñ–¥—å: ${item.clarifyAnswer}</div>`;
      }

      let editHtml = '';
      if (item.editSummary) {
        editHtml = `<div class="mt-2 small text-muted"><i class="bi bi-pencil-square"></i> –ó–º—ñ–Ω–∏: ${item.editSummary}</div>`;
      }

      const userComment = item.userComment ? `<div class="mt-2 small text-muted"><i class="bi bi-chat-quote"></i> –ö–æ–º–µ–Ω—Ç–∞—Ä: ${item.userComment}</div>` : '';
      const adminComment = item.adminComment ? `<div class="mt-1 small text-muted"><i class="bi bi-chat-right-text"></i> –ö–æ–º–µ–Ω—Ç–∞—Ä –∞–¥–º—ñ–Ω–∞: ${item.adminComment}</div>` : '';
      const paymentCard = item.paymentCard ? ` (${item.paymentCard})` : '';

      let expensesBadge = '';

      let clarifyAnswerHtml = '';
      if (!isApprover && item.status === '–ü–æ—Ç—Ä–µ–±—É—î —É—Ç–æ—á–Ω–µ–Ω–Ω—è') {
        clarifyAnswerHtml = `
            <div class="mt-2 no-modal">
              <textarea class="form-control mb-2" id="clarify-answer-${item.reqId}" rows="2" placeholder="–í–∞—à–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—å..."></textarea>
              <button class="btn btn-warning w-100" onclick="submitClarificationAnswer('${item.reqId}', this)">–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ —É—Ç–æ—á–Ω–µ–Ω–Ω—è</button>
            </div>`;
      }

      let expenseHtml = '';
      if (!isApprover && item.status === '–ü–æ–≥–æ–¥–∂–µ–Ω–æ') {
        expenseHtml = `
            <div class="mt-2 no-modal">
              <button class="btn btn-outline-primary w-100" onclick="toggleExpensesForm('${item.reqId}')">–î–æ–¥–∞—Ç–∏ –≤–∏—Ç—Ä–∞—Ç–∏</button>
              <div class="mt-2 d-none" id="exp-block-${item.reqId}">
                <div id="exp-rows-${item.reqId}"></div>
                <div class="d-flex gap-2 no-modal">
                  <button class="btn btn-light flex-grow-1" onclick="addExpenseRow('${item.reqId}')">+ –î–æ–¥–∞—Ç–∏ —â–µ</button>
                  <button class="btn btn-success flex-grow-1" onclick="submitExpenses('${item.reqId}', this)">–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏</button>
                </div>
              </div>
            </div>`;
      }

      const completeBtn = (!isApprover && item.status === '–ü–æ–≥–æ–¥–∂–µ–Ω–æ' && canCompleteTrip(item))
        ? `<div class="mt-2 no-modal"><button class="btn btn-outline-success w-100" onclick="completeTrip('${item.reqId}', this)">–ó–∞–≤–µ—Ä—à–∏—Ç–∏ –≤—ñ–¥—Ä—è–¥–∂–µ–Ω–Ω—è</button></div>`
        : '';

      const transportLine = '';

      return `
          <div class="card p-3 ${borderClass}" id="${cardId}" onclick="openDetailsModal('${item.reqId}', event)">
             <div class="d-flex justify-content-between mb-2"><span class="badge bg-light text-dark border">${item.company}</span>${getStatusBadge(item.status)}</div>
             ${isApprover ? `<h6 class="fw-bold mb-0">${item.userName}</h6><small class="text-muted mb-2 d-block">${item.dept}</small>` : ''}
             <div class="fw-bold fs-5 mb-1">${item.purpose}</div>
             <div class="text-muted small mb-2"><i class="bi bi-calendar"></i> ${item.dStart} ‚Äî ${item.dEnd}</div>
             <div class="bg-light rounded p-2 small">
                ${transportLine}
                <div class="d-flex justify-content-between"><span>–î–æ–±–æ–≤—ñ (${item.people} —á–æ–ª):</span> <strong>${item.dailyTotal}</strong></div>
                <div class="d-flex justify-content-between"><span>–ü–ª–∞–Ω–æ–≤—ñ –≤–∏—Ç—Ä–∞—Ç–∏:</span> <strong>${planTotal}</strong></div>
                <div class="d-flex justify-content-between"><span>–ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω—ñ –≤–∏—Ç—Ä–∞—Ç–∏:</span> <strong>${approvedExtra}</strong></div>
                <div class="d-flex justify-content-between"><span>–û–ø–ª–∞—Ç–∞:</span> <strong>${item.payment}${paymentCard}</strong></div>
                <div class="d-flex justify-content-between border-top mt-1 pt-1 fw-bold text-dark"><span>–†–ê–ó–û–ú:</span> <span>${totalSum} ‚Ç¥</span></div>
             </div>
             ${userComment}
             ${adminComment}
             ${expensesBadge}
             ${editHtml}
             ${clarifyHtml}
             ${clarifyAnswerHtml}
             ${expenseHtml}
             ${completeBtn}
             ${footerHtml}
          </div>`;
    }

    function showToast(msg) { document.getElementById('toastMessage').innerText = msg; toastInstance.show(); }
      function getStatusBadge(s) {
        if (s === '–ù–æ–≤–∞') return '<span class="badge-status st-new">–ù–æ–≤–∞</span>';
        if (s === '–ü–æ–≥–æ–¥–∂–µ–Ω–æ') return '<span class="badge-status st-approved">–ü–æ–≥–æ–¥–∂–µ–Ω–æ</span>';
        if (s === '–û–ø–ª–∞—á–µ–Ω–æ') return '<span class="badge-status st-approved">–û–ø–ª–∞—á–µ–Ω–æ</span>';
        if (s === '–ü–æ—Ç—Ä–µ–±—É—î —É—Ç–æ—á–Ω–µ–Ω–Ω—è') return '<span class="badge-status st-clarify">–ü–æ—Ç—Ä–µ–±—É—î —É—Ç–æ—á–Ω–µ–Ω–Ω—è</span>';
        if (s === '–£—Ç–æ—á–Ω–µ–Ω–æ') return '<span class="badge-status st-clarified">–£—Ç–æ—á–Ω–µ–Ω–æ</span>';
        if (s === '–ó–∞–≤–µ—Ä—à–µ–Ω–æ') return '<span class="badge-status st-completed">–ó–∞–≤–µ—Ä—à–µ–Ω–æ</span>';
        if (s === '–í—ñ–¥—Ö–∏–ª–µ–Ω–æ') return '<span class="badge-status st-rejected">–í—ñ–¥—Ö–∏–ª–µ–Ω–æ</span>';
        return `<span class="badge-status st-rejected">${s || ''}</span>`;
      }

    function renderExpenseCard(item) {
      const files = item.fileUrls ? item.fileUrls.split(',').filter(Boolean).map(u => `<a href="${u.trim()}" target="_blank">—Ñ–∞–π–ª</a>`).join(', ') : '';
      return `
          <div class="card p-3 marker-gray" id="exp-${item.expenseId}">
            <div class="d-flex justify-content-between mb-2">
              <span class="badge bg-light text-dark border">${item.company}</span>
              <span class="badge-status st-new">–í–∏—Ç—Ä–∞—Ç–∏</span>
            </div>
            <div class="fw-bold">${item.userName}</div>
            <div class="text-muted small mb-2">–ó–∞—è–≤–∫–∞: ${item.reqId}</div>
            <div class="bg-light rounded p-2 small">
              <div class="d-flex justify-content-between"><span>–ù–∞–∑–≤–∞:</span> <strong>${item.name}</strong></div>
              <div class="d-flex justify-content-between"><span>–°—É–º–∞:</span> <strong>${item.amount}</strong></div>
              ${item.description ? `<div class="mt-1">${item.description}</div>` : ''}
              ${item.link ? `<div class="mt-1"><a href="${item.link}" target="_blank">${item.link}</a></div>` : ''}
              ${files ? `<div class="mt-1">–§–∞–π–ª–∏: ${files}</div>` : ''}
            </div>
            <div class="d-flex gap-2 mt-3 pt-2 border-top">
              <button class="btn btn-outline-danger flex-grow-1" onclick="decideExpense('${item.expenseId}', 'reject')">–í—ñ–¥—Ö–∏–ª–∏—Ç–∏</button>
              <button class="btn btn-success flex-grow-1" onclick="decideExpense('${item.expenseId}', 'approve')">–ü–æ–≥–æ–¥–∏—Ç–∏</button>
            </div>
          </div>`;
    }

    function renderExpenseGroupCard(group) {
      const total = group.items.reduce((sum, i) => sum + parseMoney(i.amount), 0);
      const ids = group.items.map(i => i.expenseId);
      const itemsHtml = group.items.map(i => `
        <div class="d-flex justify-content-between align-items-center small exp-item-row" data-exp-id="${i.expenseId}">
          <label class="d-flex align-items-center gap-2 no-modal">
            <input type="checkbox" class="form-check-input no-modal exp-select">
            <span>${i.name}</span>
          </label>
          <input type="number" class="form-control form-control-sm no-modal exp-amount" style="max-width: 110px;" value="${i.amount}" oninput="updateExpenseGroupTotal('${group.reqId}')">
        </div>
      `).join('');

      return `
        <div class="card p-3 marker-gray" id="exp-group-${group.reqId}" onclick="openDetailsModal('${group.reqId}', event)">
          <div class="d-flex justify-content-between mb-2">
            <span class="badge bg-light text-dark border">${group.company}</span>
            <span class="badge-status st-new">–í–∏—Ç—Ä–∞—Ç–∏</span>
          </div>
          <div class="fw-bold">${group.userName}</div>
          <div class="text-muted small mb-2">${group.purpose} ‚Ä¢ ${group.dStart} ‚Äî ${group.dEnd}</div>
          <div class="bg-light rounded p-2 small">
            ${itemsHtml}
            <div class="d-flex justify-content-between border-top mt-1 pt-1 fw-bold text-dark">
              <span>–†–∞–∑–æ–º:</span><span id="exp-total-${group.reqId}">${total} ‚Ç¥</span>
            </div>
          </div>
          <div class="d-flex gap-2 mt-3 pt-2 border-top no-modal">
            <button class="btn btn-outline-danger flex-grow-1" data-exp-ids='${JSON.stringify(ids)}' onclick="decideExpenseBatchFromBtn('${group.reqId}', 'reject', this)">–í—ñ–¥—Ö–∏–ª–∏—Ç–∏</button>
            <button class="btn btn-success flex-grow-1" data-exp-ids='${JSON.stringify(ids)}' onclick="decideExpenseBatchFromBtn('${group.reqId}', 'approve', this)">–ü–æ–≥–æ–¥–∏—Ç–∏</button>
          </div>
        </div>`;
    }

    function decideExpenseBatchFromBtn(reqId, decision, btn) {
      const raw = btn ? btn.getAttribute('data-exp-ids') : '[]';
      let ids = [];
      try { ids = JSON.parse(raw || '[]'); } catch (e) { ids = []; }
      const selection = collectExpenseDecision(reqId, ids);
      decideExpenseBatch(reqId, selection.ids, decision, selection.items, btn);
    }

    function collectExpenseDecision(reqId, fallbackIds) {
      const card = document.getElementById(`exp-group-${reqId}`);
      if (!card) return { ids: fallbackIds || [], items: [] };
      const rows = Array.from(card.querySelectorAll('.exp-item-row'));
      const all = [];
      const selected = [];
      rows.forEach(r => {
        const id = r.getAttribute('data-exp-id');
        const chk = r.querySelector('.exp-select');
        const amtEl = r.querySelector('.exp-amount');
        const amount = parseMoney(amtEl ? amtEl.value : '');
        const entry = { expenseId: id, amount: amount };
        all.push(entry);
        if (chk && chk.checked) selected.push(entry);
      });
      const chosen = selected.length ? selected : all;
      return { ids: chosen.map(i => i.expenseId), items: chosen };
    }

    function updateExpenseGroupTotal(reqId) {
      const card = document.getElementById(`exp-group-${reqId}`);
      if (!card) return;
      const totalEl = document.getElementById(`exp-total-${reqId}`);
      if (!totalEl) return;
      const rows = Array.from(card.querySelectorAll('.exp-item-row'));
      let sum = 0;
      rows.forEach(r => {
        const amtEl = r.querySelector('.exp-amount');
        const amount = parseMoney(amtEl ? amtEl.value : '');
        sum += amount;
      });
      totalEl.textContent = sum + ' ‚Ç¥';
    }

    async function openDetailsModal(reqId, ev) {
      if (ev && ev.target) {
        if (ev.target.closest('.no-modal')) return;
      }
      const req = REQUEST_CACHE[reqId];
      if (!req) { showToast("–î–∞–Ω—ñ –∑–∞—è–≤–∫–∏ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ"); return; }
      document.getElementById('detailsBody').innerHTML = '<div class="text-center text-muted">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>';
      detailsModalInstance.show();

      let expenses = DETAILS_EXPENSE_CACHE[reqId];
      if (!expenses) {
        try {
          const res = await fetch(`${API_URL}?action=getExpensesByReqId&userId=${USER_ID}&reqId=${reqId}`);
          expenses = await res.json();
          if (expenses && expenses.error) expenses = [];
          DETAILS_EXPENSE_CACHE[reqId] = expenses;
        } catch (e) {
          expenses = [];
        }
      }
      document.getElementById('detailsBody').innerHTML = renderDetailsBody(req, expenses);
    }

    function renderDetailsBody(req, expenses) {
      const approvedExtra = parseFloat(req.additionalItemsTotal || 0) || 0;
      const planTotal = parseFloat(req.planItemsTotal || 0) || 0;
      const totalSum = (parseFloat(req.dailyTotal) || 0) + planTotal + approvedExtra;
      const paymentCard = req.paymentCard ? ` (${req.paymentCard})` : '';
      const edits = req.editSummary ? `<div class="mt-2"><strong>–ó–º—ñ–Ω–∏:</strong><br>${formatChangeLines(req.editSummary)}</div>` : '';
      const adminComment = req.adminComment ? `<div class="mt-2"><strong>–ö–æ–º–µ–Ω—Ç–∞—Ä –∞–¥–º—ñ–Ω–∞:</strong> ${req.adminComment}</div>` : '';
      const userComment = req.userComment ? `<div class="mt-2"><strong>–ö–æ–º–µ–Ω—Ç–∞—Ä:</strong> ${req.userComment}</div>` : '';
      const tgError = getLastLogText(req.logEntries || [], 'telegram_error');
      const tgErrorHtml = tgError ? `<div class="mt-2 text-danger"><strong>Telegram:</strong> ${tgError}</div>` : '';
      const clarify = req.clarifyQuestion ? `
        <div class="mt-2"><strong>–£—Ç–æ—á–Ω–µ–Ω–Ω—è:</strong> ${req.clarifyQuestion}</div>
        ${req.clarifyAnswer ? `<div class="mt-1"><strong>–í—ñ–¥–ø–æ–≤—ñ–¥—å:</strong> ${req.clarifyAnswer}</div>` : ''}
        ${req.clarifyByName ? `<div class="mt-1"><strong>–ó–∞–ø—Ä–æ—Å–∏–≤:</strong> ${req.clarifyByName}</div>` : ''}
      ` : '';

      const expensesHtml = renderExpensesGroupedByDate(expenses);
      const planItems = parsePlanItems(req.planItemsJson);
      const planHtml = planItems.length
        ? planItems.map(i => `<div class="d-flex justify-content-between small"><span>${i.name}</span><strong>${i.amount}</strong></div>`).join('')
        : '<div class="text-muted small">–ù–µ–º–∞—î</div>';

      return `
        <div class="mb-2">
          <div class="d-flex justify-content-between mb-1"><span class="badge bg-light text-dark border">${req.company}</span>${getStatusBadge(req.status)}</div>
          <div class="fw-bold">${req.purpose}</div>
          <div class="small text-muted">${formatDate(req.dStart)} ‚Äî ${formatDate(req.dEnd)}</div>
        </div>
        <div class="bg-light rounded p-2 small mb-2">
          <div class="d-flex justify-content-between"><span>–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á:</span><strong>${req.userName}</strong></div>
          <div class="d-flex justify-content-between"><span>–í—ñ–¥–¥—ñ–ª:</span><strong>${req.dept}</strong></div>
          <div class="d-flex justify-content-between"><span>–î–æ–±–æ–≤—ñ (${req.people} —á–æ–ª):</span><strong>${req.dailyTotal}</strong></div>
          <div class="d-flex justify-content-between"><span>–°—Ç–∞–≤–∫–∞ –¥–æ–±–æ–≤–∏—Ö:</span><strong>${req.perDiemName} (${req.perDiemRate})</strong></div>
          <div class="d-flex justify-content-between"><span>–û–ø–ª–∞—Ç–∞:</span><strong>${req.payment}${paymentCard}</strong></div>
          <div class="d-flex justify-content-between"><span>–ü–ª–∞–Ω–æ–≤—ñ –≤–∏—Ç—Ä–∞—Ç–∏:</span><strong>${planTotal}</strong></div>
          <div class="d-flex justify-content-between"><span>–ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω—ñ –≤–∏—Ç—Ä–∞—Ç–∏:</span><strong>${approvedExtra}</strong></div>
          <div class="d-flex justify-content-between border-top mt-1 pt-1 fw-bold"><span>–†–ê–ó–û–ú:</span><span>${totalSum} ‚Ç¥</span></div>
        </div>
        <div class="small text-muted">
          <div>–°—Ç–≤–æ—Ä–µ–Ω–æ: ${formatDateTime(req.created)}</div>
          ${req.updatedAt ? `<div>–û–Ω–æ–≤–ª–µ–Ω–æ: ${formatDateTime(req.updatedAt)}</div>` : ''}
          ${req.editedBy ? `<div>–†–µ–¥–∞–∫—Ç–æ—Ä: ${req.editedBy}</div>` : ''}
          ${req.approver ? `<div>–ü–æ–≥–æ–¥–∏–≤: ${req.approver}</div>` : ''}
          ${req.completedAt ? `<div>–ó–∞–≤–µ—Ä—à–µ–Ω–æ: ${formatDateTime(req.completedAt)}</div>` : ''}
        </div>
        ${userComment}
        ${adminComment}
        ${edits}
        ${clarify}
        ${tgErrorHtml}
        <div class="mt-3">
          <div class="fw-bold mb-1">–ü–ª–∞–Ω–æ–≤—ñ –≤–∏—Ç—Ä–∞—Ç–∏</div>
          ${planHtml}
        </div>
        <div class="mt-3">
          <div class="fw-bold mb-1">–î–æ–¥–∞—Ç–∫–æ–≤—ñ –≤–∏—Ç—Ä–∞—Ç–∏</div>
          ${expensesHtml}
        </div>
      `;
    }

    function formatChangeLines(summary) {
      return summary.split(';').map(s => s.trim()).filter(Boolean).map(s => `${s};`).join('<br>');
    }

    function formatDate(val) {
      if (!val) return '';
      const s = String(val);
      if (s.includes('T')) {
        const d = new Date(s);
        if (!isNaN(d.getTime())) return pad2(d.getDate()) + '.' + pad2(d.getMonth() + 1) + '.' + d.getFullYear();
      }
      if (/^\d{4}-\d{2}-\d{2}$/.test(s)) {
        const [y, m, d] = s.split('-');
        return `${d}.${m}.${y}`;
      }
      if (/^\d{2}\.\d{2}\.\d{4}/.test(s)) return s.slice(0, 10);
      return s;
    }

    function formatDateTime(val) {
      if (!val) return '';
      const s = String(val);
      if (s.includes('T')) {
        const d = new Date(s);
        if (!isNaN(d.getTime())) {
          return pad2(d.getDate()) + '.' + pad2(d.getMonth() + 1) + '.' + d.getFullYear() + ' ' + pad2(d.getHours()) + ':' + pad2(d.getMinutes());
        }
      }
      if (/^\d{2}\.\d{2}\.\d{4}/.test(s)) return s;
      return s;
    }

    function pad2(n) { return String(n).padStart(2, '0'); }

    function renderExpensesGroupedByDate(expenses) {
      if (!expenses || expenses.length === 0) return '<div class="text-muted small">–ù–µ–º–∞—î –≤–∏—Ç—Ä–∞—Ç</div>';
      const groups = {};
      expenses.forEach(e => {
        const key = formatDate(e.created);
        if (!groups[key]) groups[key] = [];
        groups[key].push(e);
      });
      const dates = Object.keys(groups).sort((a, b) => b.localeCompare(a));
      return dates.map(date => {
        const itemsHtml = groups[date].map(e => {
          const files = e.fileUrls ? e.fileUrls.split(',').filter(Boolean).map(u => `<a href="${u.trim()}" target="_blank">—Ñ–∞–π–ª</a>`).join(', ') : '';
          const statusLine = [
            e.status || '',
            e.approver || '',
            e.decidedAt ? formatDateTime(e.decidedAt) : ''
          ].filter(Boolean).join(' ‚Ä¢ ');
          return `
            <div class="border rounded p-2 mb-2">
              <div class="d-flex justify-content-between"><strong>${e.name}</strong><span>${e.amount}</span></div>
              ${e.description ? `<div class="small text-muted">${e.description}</div>` : ''}
              ${e.link ? `<div class="small"><a href="${e.link}" target="_blank">${e.link}</a></div>` : ''}
              ${files ? `<div class="small">–§–∞–π–ª–∏: ${files}</div>` : ''}
              <div class="small text-muted">${statusLine ? `–°—Ç–∞—Ç—É—Å: ${statusLine}` : ''}</div>
            </div>
          `;
        }).join('');
        return `
          <div class="mb-2">
            <div class="small text-muted fw-bold mb-1">${date}</div>
            ${itemsHtml}
          </div>
        `;
      }).join('');
    }

    function parsePlanItems(raw) {
      if (!raw) return [];
      try {
        const arr = JSON.parse(raw);
        if (Array.isArray(arr)) return arr;
      } catch (e) {}
      return [];
    }

    function getLastLogText(entries, type) {
      if (!entries || !entries.length) return '';
      for (let i = entries.length - 1; i >= 0; i--) {
        if (entries[i].type === type) return entries[i].text || '';
      }
      return '';
    }

    function canCompleteTrip(item) {
      if (!item || !item.dEnd) return false;
      const today = new Date();
      const d = parseDateSafe(item.dEnd);
      if (!d) return false;
      return d <= today;
    }

    function parseDateSafe(val) {
      if (!val) return null;
      const s = String(val);
      if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return new Date(s);
      if (/^\d{2}\.\d{2}\.\d{4}$/.test(s)) {
        const [dd, mm, yyyy] = s.split('.');
        return new Date(`${yyyy}-${mm}-${dd}`);
      }
      const d = new Date(s);
      return isNaN(d.getTime()) ? null : d;
    }

    function isActionableStatus(status) {
      return status === '–ù–æ–≤–∞' || status === '–£—Ç–æ—á–Ω–µ–Ω–æ' || status === '–ü–æ—Ç—Ä–µ–±—É—î —É—Ç–æ—á–Ω–µ–Ω–Ω—è';
    }

    function isActiveStatus(status) {
      return status === '–ù–æ–≤–∞' || status === '–£—Ç–æ—á–Ω–µ–Ω–æ' || status === '–ü–æ—Ç—Ä–µ–±—É—î —É—Ç–æ—á–Ω–µ–Ω–Ω—è' || status === '–ü–æ–≥–æ–¥–∂–µ–Ω–æ';
    }

    function compareDateAsc(a, b) {
      const da = parseDateSafe(a);
      const db = parseDateSafe(b);
      if (da && db) return da - db;
      return String(a).localeCompare(String(b));
    }

    function toggleCompleted() {
      const block = document.getElementById('completedBlock');
      if (!block) return;
      block.classList.toggle('d-none');
      localStorage.setItem('trip_completed_collapsed', block.classList.contains('d-none') ? '1' : '0');
    }

    function toggleAdminSection(section) {
      const map = {
        approval: { id: 'adminApprovalBlock', key: 'trip_admin_approval_collapsed' },
        accounting: { id: 'adminAccountingBlock', key: 'trip_admin_accounting_collapsed' },
        archive: { id: 'adminArchiveBlock', key: 'trip_admin_archive_collapsed' }
      };
      const cfg = map[section];
      if (!cfg) return;
      const block = document.getElementById(cfg.id);
      if (!block) return;
      block.classList.toggle('d-none');
      localStorage.setItem(cfg.key, block.classList.contains('d-none') ? '1' : '0');
    }

    // backward compatibility (old name)
    function toggleCompletedAdmin() {
      toggleAdminSection('approval');
    }

    // Confirm-close state
    let PENDING_COMPLETE_REQ_ID = null;
    let PENDING_COMPLETE_BTN = null;

    function openCompleteConfirm(reqId, btn) {
      PENDING_COMPLETE_REQ_ID = reqId;
      PENDING_COMPLETE_BTN = btn || null;
      const modalEl = document.getElementById('confirmCompleteModal');
      if (!modalEl) return;
      const m = bootstrap.Modal.getOrCreateInstance(modalEl);
      m.show();
    }

    async function doCompleteTrip() {
      const reqId = PENDING_COMPLETE_REQ_ID;
      const btn = PENDING_COMPLETE_BTN;
      if (!reqId) return;

      setBtnLoading(btn, true);
      try {
        const res = await sendPost('completeTrip', { rowId: reqId, userId: USER_ID });
        if (res.status === 'success') { showToast(res.message); loadUserHistory(); }
        else showToast(res.message);
      } catch (err) { showToast("–ü–æ–º–∏–ª–∫–∞: " + err); }
      setBtnLoading(btn, false);

      // reset
      PENDING_COMPLETE_REQ_ID = null;
      PENDING_COMPLETE_BTN = null;
    }

    // Wire modal confirm button
    document.addEventListener('DOMContentLoaded', () => {
      const btn = document.getElementById('confirmCompleteBtn');
      if (btn) {
        btn.addEventListener('click', async () => {
          const modalEl = document.getElementById('confirmCompleteModal');
          try { bootstrap.Modal.getOrCreateInstance(modalEl).hide(); } catch (e) {}
          await doCompleteTrip();
        });
      }
    });

    async function completeTrip(reqId, btn) {
      // Client-side guard (backend also enforces): don't allow closing if there are unresolved additional expenses.
      try {
        const expRes = await fetch(`${API_URL}?action=getExpensesByReqId&userId=${USER_ID}&reqId=${reqId}`);
        const expenses = await expRes.json();
        const arr = Array.isArray(expenses) ? expenses : [];
        const FINAL = { '–ü–æ–≥–æ–¥–∂–µ–Ω–æ': true, '–í—ñ–¥—Ö–∏–ª–µ–Ω–æ': true };
        const blocking = arr.filter(e => !FINAL[String((e && e.status) || '')]);
        if (blocking.length) {
          showToast('–£ –≤–∞—Å —î –Ω–µ—É–∑–≥–æ–¥–∂–µ–Ω—ñ –¥–æ–¥–∞—Ç–∫–æ–≤—ñ –≤–∏—Ç—Ä–∞—Ç–∏. –î–æ—á–µ–∫–∞–π—Ç–µ—Å—å —Ä—ñ—à–µ–Ω–Ω—è –∫–µ—Ä—ñ–≤–Ω–∏–∫–∞ –ø–µ—Ä–µ–¥ –∑–∞–∫—Ä–∏—Ç—Ç—è–º.');
          return;
        }
      } catch (e) {
        // ignore; backend will still enforce
      }

      openCompleteConfirm(reqId, btn);
    }
  </script>
</body>

</html>
